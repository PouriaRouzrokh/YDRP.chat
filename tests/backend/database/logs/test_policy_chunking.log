2025-04-09 21:33:00,119 - TestPolicyChunking - INFO - Backend logging initialized. Log file: /Users/pouria/Documents/Coding/YDR Policy Scraping/tests/backend/database/logs/test_policy_chunking.log
2025-04-09 21:33:00,120 - TestPolicyChunking - INFO - Connecting to admin database to drop ydrpolicy_test
2025-04-09 21:33:00,142 - TestPolicyChunking - INFO - Database ydrpolicy_test does not exist
2025-04-09 21:33:00,145 - TestPolicyChunking - INFO - Connecting to admin database to create ydrpolicy_test
2025-04-09 21:33:00,214 - TestPolicyChunking - INFO - Created database ydrpolicy_test
2025-04-09 21:33:00,216 - TestPolicyChunking - INFO - Setting up database at postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy_test
2025-04-09 21:33:00,224 - TestPolicyChunking - INFO - Connection test result: 1
2025-04-09 21:33:00,232 - TestPolicyChunking - INFO - Vector extension created or exists
2025-04-09 21:33:00,261 - TestPolicyChunking - INFO - Tables created
2025-04-09 21:33:00,265 - TestPolicyChunking - INFO - Search vector triggers created
2025-04-09 21:33:00,269 - TestPolicyChunking - INFO - Testing chunking functionality...
2025-04-09 21:33:00,270 - TestPolicyChunking - INFO - Chunked text with size=50: 18 chunks produced
2025-04-09 21:33:00,270 - TestPolicyChunking - INFO -   Chunk 0: 25 chars: This is a test paragraph....
2025-04-09 21:33:00,271 - TestPolicyChunking - INFO -   Chunk 1: 50 chars: This is another paragraph with...
2025-04-09 21:33:00,271 - TestPolicyChunking - INFO -   Chunk 2: 27 chars: ent that should be chunked....
2025-04-09 21:33:00,271 - TestPolicyChunking - INFO -   Chunk 3: 10 chars: e chunked....
2025-04-09 21:33:00,272 - TestPolicyChunking - INFO -   Chunk 4: 50 chars: It includes
    multiple sente...
2025-04-09 21:33:00,272 - TestPolicyChunking - INFO -   Chunk 5: 27 chars: st sentence-level chunking....
2025-04-09 21:33:00,272 - TestPolicyChunking - INFO -   Chunk 6: 10 chars:  chunking....
2025-04-09 21:33:00,273 - TestPolicyChunking - INFO -   Chunk 7: 50 chars: Each sentence should ideally
 ...
2025-04-09 21:33:00,273 - TestPolicyChunking - INFO -   Chunk 8: 31 chars:  together unless it's too long...
2025-04-09 21:33:00,273 - TestPolicyChunking - INFO -   Chunk 9: 10 chars:  too long....
2025-04-09 21:33:00,273 - TestPolicyChunking - INFO -   Chunk 10: 10 chars:  too long....
2025-04-09 21:33:00,274 - TestPolicyChunking - INFO -   Chunk 11: 50 chars: A third paragraph begins here ...
2025-04-09 21:33:00,274 - TestPolicyChunking - INFO -   Chunk 12: 28 chars: ues with additional content....
2025-04-09 21:33:00,274 - TestPolicyChunking - INFO -   Chunk 13: 10 chars: l content....
2025-04-09 21:33:00,275 - TestPolicyChunking - INFO -   Chunk 14: 50 chars: This paragraph also has multip...
2025-04-09 21:33:00,275 - TestPolicyChunking - INFO -   Chunk 15: 33 chars: es for testing chunking behavi...
2025-04-09 21:33:00,275 - TestPolicyChunking - INFO -   Chunk 16: 10 chars:  behavior....
2025-04-09 21:33:00,276 - TestPolicyChunking - INFO -   Chunk 17: 10 chars:  behavior....
2025-04-09 21:33:00,276 - TestPolicyChunking - INFO - Chunked text with size=100: 9 chunks produced
2025-04-09 21:33:00,276 - TestPolicyChunking - INFO -   Chunk 0: 25 chars: This is a test paragraph....
2025-04-09 21:33:00,277 - TestPolicyChunking - INFO -   Chunk 1: 67 chars: This is another paragraph with...
2025-04-09 21:33:00,277 - TestPolicyChunking - INFO -   Chunk 2: 67 chars: It includes
    multiple sente...
2025-04-09 21:33:00,277 - TestPolicyChunking - INFO -   Chunk 3: 82 chars:  chunking. Each sentence shoul...
2025-04-09 21:33:00,277 - TestPolicyChunking - INFO -   Chunk 4: 10 chars:  too long....
2025-04-09 21:33:00,278 - TestPolicyChunking - INFO -   Chunk 5: 68 chars: A third paragraph begins here ...
2025-04-09 21:33:00,278 - TestPolicyChunking - INFO -   Chunk 6: 73 chars: This paragraph also has multip...
2025-04-09 21:33:00,278 - TestPolicyChunking - INFO -   Chunk 7: 10 chars:  behavior....
2025-04-09 21:33:00,279 - TestPolicyChunking - INFO -   Chunk 8: 10 chars:  behavior....
2025-04-09 21:33:00,279 - TestPolicyChunking - INFO - Chunked text with size=200: 5 chunks produced
2025-04-09 21:33:00,279 - TestPolicyChunking - INFO -   Chunk 0: 25 chars: This is a test paragraph....
2025-04-09 21:33:00,280 - TestPolicyChunking - INFO -   Chunk 1: 135 chars: This is another paragraph with...
2025-04-09 21:33:00,280 - TestPolicyChunking - INFO -   Chunk 2: 71 chars: Each sentence should ideally
 ...
2025-04-09 21:33:00,280 - TestPolicyChunking - INFO -   Chunk 3: 10 chars:  too long....
2025-04-09 21:33:00,280 - TestPolicyChunking - INFO -   Chunk 4: 162 chars:  too long.

    A third paragr...
2025-04-09 21:33:00,281 - TestPolicyChunking - INFO - Chunked markdown: 5 chunks produced
2025-04-09 21:33:00,281 - TestPolicyChunking - INFO -   MD Chunk 0: 0 chars: ...
2025-04-09 21:33:00,281 - TestPolicyChunking - INFO -   MD Chunk 1: 53 chars: # Heading 1
    
    This is c...
2025-04-09 21:33:00,282 - TestPolicyChunking - INFO -   MD Chunk 2: 100 chars: ## Heading 1.1
    
    This i...
2025-04-09 21:33:00,282 - TestPolicyChunking - INFO -   MD Chunk 3: 31 chars: his is content under heading 2...
2025-04-09 21:33:00,282 - TestPolicyChunking - INFO -   MD Chunk 4: 69 chars: heading 2. ## Heading 2.1
    ...
2025-04-09 21:33:00,282 - TestPolicyChunking - INFO - Testing embedding functionality...
2025-04-09 21:33:01,270 - TestPolicyChunking - INFO - Generated embedding for single text: 1536 dimensions
2025-04-09 21:33:01,575 - TestPolicyChunking - INFO - Generated 3 embeddings in batch mode
2025-04-09 21:33:01,576 - TestPolicyChunking - INFO -   Embedding 0: 1536 dimensions
2025-04-09 21:33:01,577 - TestPolicyChunking - INFO -   Embedding 1: 1536 dimensions
2025-04-09 21:33:01,578 - TestPolicyChunking - INFO -   Embedding 2: 1536 dimensions
2025-04-09 21:33:01,578 - TestPolicyChunking - INFO - Testing policy chunking and embedding DB integration
2025-04-09 21:33:01,603 - TestPolicyChunking - INFO - Created test policy with ID: 1
2025-04-09 21:33:01,604 - TestPolicyChunking - INFO - Split policy into 3 chunks
2025-04-09 21:33:01,883 - TestPolicyChunking - INFO - Generated 3 embeddings
2025-04-09 21:33:01,905 - TestPolicyChunking - INFO - Created chunk 0: ID=1, 959 chars
2025-04-09 21:33:01,910 - TestPolicyChunking - INFO - Created chunk 1: ID=2, 89 chars
2025-04-09 21:33:01,914 - TestPolicyChunking - INFO - Created chunk 2: ID=3, 89 chars
2025-04-09 21:33:01,917 - TestPolicyChunking - INFO - Retrieved 3 chunks for policy
2025-04-09 21:33:01,919 - TestPolicyChunking - INFO - Text search for 'guideline' returned 1 results
2025-04-09 21:33:01,919 - TestPolicyChunking - INFO -   Result 0: score=0.0890, content=# Test Policy Document
            
            ##...
2025-04-09 21:33:01,921 - TestPolicyChunking - INFO - Text search for 'compliance' returned 1 results
2025-04-09 21:33:01,921 - TestPolicyChunking - INFO -   Result 0: score=0.0760, content=# Test Policy Document
            
            ##...
2025-04-09 21:33:01,923 - TestPolicyChunking - INFO - Text search for 'introduction' returned 1 results
2025-04-09 21:33:01,923 - TestPolicyChunking - INFO -   Result 0: score=0.0608, content=# Test Policy Document
            
            ##...
2025-04-09 21:33:01,927 - TestPolicyChunking - INFO - Embedding search returned 1 results
2025-04-09 21:33:01,927 - TestPolicyChunking - INFO -   Result 0: similarity=1.0000, content=# Test Policy Document
            
            ##...
2025-04-09 21:33:01,930 - TestPolicyChunking - INFO - Modified embedding search returned 1 results
2025-04-09 21:33:01,930 - TestPolicyChunking - INFO - Original similarity: 1.0000, Modified similarity: 0.6548
2025-04-09 21:33:01,931 - TestPolicyChunking - INFO - Confirmed exact match has higher similarity than modified embedding
2025-04-09 21:33:01,935 - TestPolicyChunking - INFO - Baseline results: 1, Higher threshold (0.9500) results: 1
2025-04-09 21:33:01,935 - TestPolicyChunking - INFO - Confirmed similarity threshold filtering works correctly
2025-04-09 21:33:01,939 - TestPolicyChunking - INFO - Hybrid search returned 1 results
2025-04-09 21:33:01,940 - TestPolicyChunking - INFO -   Result 0: combined=0.8178, text=0.0890, vector=1.0000
2025-04-09 21:33:01,944 - TestPolicyChunking - INFO - Retrieved neighbors for chunk 2 (index 1)
2025-04-09 21:33:01,945 - TestPolicyChunking - INFO -   Previous chunks: [1]
2025-04-09 21:33:01,945 - TestPolicyChunking - INFO -   Next chunks: [3]
2025-04-09 21:33:01,950 - TestPolicyChunking - INFO - Retrieved 1 unique policies from chunk results
2025-04-09 21:33:01,951 - TestPolicyChunking - INFO - Test successful: committed all changes
2025-04-09 21:33:01,959 - TestPolicyChunking - INFO - Testing comprehensive repository functions...
2025-04-09 21:33:01,960 - TestPolicyChunking - WARNING - is_active field not present in User model, continuing without it
2025-04-09 21:33:01,978 - TestPolicyChunking - INFO - Created users: admin=1, regular=2, inactive=3
2025-04-09 21:33:01,980 - TestPolicyChunking - INFO - Skipping username tests as User model uses email for identification
2025-04-09 21:33:01,982 - TestPolicyChunking - WARNING - Authentication method has incompatible signature, skipping test
2025-04-09 21:33:01,992 - TestPolicyChunking - INFO - Created policy 0: ID=2
2025-04-09 21:33:01,994 - TestPolicyChunking - INFO - Created policy 1: ID=3
2025-04-09 21:33:01,995 - TestPolicyChunking - INFO - Created policy 2: ID=4
2025-04-09 21:33:02,001 - TestPolicyChunking - INFO - Skipping get_policy_details test due to issues with selectinload.order_by
2025-04-09 21:33:02,002 - TestPolicyChunking - INFO - Full text search found 4 results
2025-04-09 21:33:02,009 - TestPolicyChunking - INFO - Found 1 update history records
2025-04-09 21:33:02,032 - TestPolicyChunking - INFO - All repository function tests completed successfully
2025-04-09 21:33:02,037 - TestPolicyChunking - INFO - All policy chunking and embedding tests passed successfully!
2025-04-09 21:33:02,038 - TestPolicyChunking - INFO - Connecting to admin database to drop ydrpolicy_test
2025-04-09 21:33:02,049 - TestPolicyChunking - INFO - Terminating all connections to ydrpolicy_test
2025-04-09 21:33:02,553 - TestPolicyChunking - INFO - Dropping database ydrpolicy_test
2025-04-09 21:33:02,587 - TestPolicyChunking - INFO - Dropped database ydrpolicy_test
2025-04-09 22:22:11,770 - TestPolicyChunking - INFO - Backend logging initialized. Log file: /Users/pouria/Documents/Coding/YDR Policy Scraping/tests/backend/database/logs/test_policy_chunking.log
2025-04-09 22:22:11,771 - TestPolicyChunking - INFO - Connecting to admin database to drop ydrpolicy_test
2025-04-09 22:22:11,791 - TestPolicyChunking - INFO - Database ydrpolicy_test does not exist
2025-04-09 22:22:11,795 - TestPolicyChunking - INFO - Connecting to admin database to create ydrpolicy_test
2025-04-09 22:22:11,869 - TestPolicyChunking - INFO - Created database ydrpolicy_test
2025-04-09 22:22:11,871 - TestPolicyChunking - INFO - Setting up database at postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy_test
2025-04-09 22:22:11,879 - TestPolicyChunking - INFO - Connection test result: 1
2025-04-09 22:22:11,887 - TestPolicyChunking - INFO - Vector extension created or exists
2025-04-09 22:22:11,917 - TestPolicyChunking - INFO - Tables created
2025-04-09 22:22:11,920 - TestPolicyChunking - INFO - Search vector triggers created
2025-04-09 22:22:11,925 - TestPolicyChunking - INFO - Testing chunking functionality...
2025-04-09 22:22:11,925 - TestPolicyChunking - INFO - Chunked text with size=50: 18 chunks produced
2025-04-09 22:22:11,926 - TestPolicyChunking - INFO -   Chunk 0: 25 chars: This is a test paragraph....
2025-04-09 22:22:11,926 - TestPolicyChunking - INFO -   Chunk 1: 50 chars: This is another paragraph with...
2025-04-09 22:22:11,926 - TestPolicyChunking - INFO -   Chunk 2: 27 chars: ent that should be chunked....
2025-04-09 22:22:11,926 - TestPolicyChunking - INFO -   Chunk 3: 10 chars: e chunked....
2025-04-09 22:22:11,927 - TestPolicyChunking - INFO -   Chunk 4: 50 chars: It includes
    multiple sente...
2025-04-09 22:22:11,927 - TestPolicyChunking - INFO -   Chunk 5: 27 chars: st sentence-level chunking....
2025-04-09 22:22:11,927 - TestPolicyChunking - INFO -   Chunk 6: 10 chars:  chunking....
2025-04-09 22:22:11,927 - TestPolicyChunking - INFO -   Chunk 7: 50 chars: Each sentence should ideally
 ...
2025-04-09 22:22:11,928 - TestPolicyChunking - INFO -   Chunk 8: 31 chars:  together unless it's too long...
2025-04-09 22:22:11,928 - TestPolicyChunking - INFO -   Chunk 9: 10 chars:  too long....
2025-04-09 22:22:11,928 - TestPolicyChunking - INFO -   Chunk 10: 10 chars:  too long....
2025-04-09 22:22:11,928 - TestPolicyChunking - INFO -   Chunk 11: 50 chars: A third paragraph begins here ...
2025-04-09 22:22:11,929 - TestPolicyChunking - INFO -   Chunk 12: 28 chars: ues with additional content....
2025-04-09 22:22:11,929 - TestPolicyChunking - INFO -   Chunk 13: 10 chars: l content....
2025-04-09 22:22:11,929 - TestPolicyChunking - INFO -   Chunk 14: 50 chars: This paragraph also has multip...
2025-04-09 22:22:11,930 - TestPolicyChunking - INFO -   Chunk 15: 33 chars: es for testing chunking behavi...
2025-04-09 22:22:11,930 - TestPolicyChunking - INFO -   Chunk 16: 10 chars:  behavior....
2025-04-09 22:22:11,930 - TestPolicyChunking - INFO -   Chunk 17: 10 chars:  behavior....
2025-04-09 22:22:11,931 - TestPolicyChunking - INFO - Chunked text with size=100: 9 chunks produced
2025-04-09 22:22:11,931 - TestPolicyChunking - INFO -   Chunk 0: 25 chars: This is a test paragraph....
2025-04-09 22:22:11,931 - TestPolicyChunking - INFO -   Chunk 1: 67 chars: This is another paragraph with...
2025-04-09 22:22:11,931 - TestPolicyChunking - INFO -   Chunk 2: 67 chars: It includes
    multiple sente...
2025-04-09 22:22:11,932 - TestPolicyChunking - INFO -   Chunk 3: 82 chars:  chunking. Each sentence shoul...
2025-04-09 22:22:11,932 - TestPolicyChunking - INFO -   Chunk 4: 10 chars:  too long....
2025-04-09 22:22:11,932 - TestPolicyChunking - INFO -   Chunk 5: 68 chars: A third paragraph begins here ...
2025-04-09 22:22:11,932 - TestPolicyChunking - INFO -   Chunk 6: 73 chars: This paragraph also has multip...
2025-04-09 22:22:11,933 - TestPolicyChunking - INFO -   Chunk 7: 10 chars:  behavior....
2025-04-09 22:22:11,933 - TestPolicyChunking - INFO -   Chunk 8: 10 chars:  behavior....
2025-04-09 22:22:11,933 - TestPolicyChunking - INFO - Chunked text with size=200: 5 chunks produced
2025-04-09 22:22:11,933 - TestPolicyChunking - INFO -   Chunk 0: 25 chars: This is a test paragraph....
2025-04-09 22:22:11,934 - TestPolicyChunking - INFO -   Chunk 1: 135 chars: This is another paragraph with...
2025-04-09 22:22:11,934 - TestPolicyChunking - INFO -   Chunk 2: 71 chars: Each sentence should ideally
 ...
2025-04-09 22:22:11,934 - TestPolicyChunking - INFO -   Chunk 3: 10 chars:  too long....
2025-04-09 22:22:11,935 - TestPolicyChunking - INFO -   Chunk 4: 162 chars:  too long.

    A third paragr...
2025-04-09 22:22:11,935 - TestPolicyChunking - INFO - Chunked markdown: 5 chunks produced
2025-04-09 22:22:11,935 - TestPolicyChunking - INFO -   MD Chunk 0: 0 chars: ...
2025-04-09 22:22:11,935 - TestPolicyChunking - INFO -   MD Chunk 1: 53 chars: # Heading 1
    
    This is c...
2025-04-09 22:22:11,936 - TestPolicyChunking - INFO -   MD Chunk 2: 100 chars: ## Heading 1.1
    
    This i...
2025-04-09 22:22:11,936 - TestPolicyChunking - INFO -   MD Chunk 3: 31 chars: his is content under heading 2...
2025-04-09 22:22:11,936 - TestPolicyChunking - INFO -   MD Chunk 4: 69 chars: heading 2. ## Heading 2.1
    ...
2025-04-09 22:22:11,937 - TestPolicyChunking - INFO - Testing embedding functionality...
2025-04-09 22:22:12,421 - TestPolicyChunking - INFO - Generated embedding for single text: 1536 dimensions
2025-04-09 22:22:12,976 - TestPolicyChunking - INFO - Generated 3 embeddings in batch mode
2025-04-09 22:22:12,976 - TestPolicyChunking - INFO -   Embedding 0: 1536 dimensions
2025-04-09 22:22:12,977 - TestPolicyChunking - INFO -   Embedding 1: 1536 dimensions
2025-04-09 22:22:12,978 - TestPolicyChunking - INFO -   Embedding 2: 1536 dimensions
2025-04-09 22:22:12,979 - TestPolicyChunking - INFO - Testing policy chunking and embedding DB integration
2025-04-09 22:22:13,018 - TestPolicyChunking - INFO - Created test policy with ID: 1
2025-04-09 22:22:13,018 - TestPolicyChunking - INFO - Split policy into 3 chunks
2025-04-09 22:22:13,385 - TestPolicyChunking - INFO - Generated 3 embeddings
2025-04-09 22:22:13,406 - TestPolicyChunking - INFO - Created chunk 0: ID=1, 959 chars
2025-04-09 22:22:13,412 - TestPolicyChunking - INFO - Created chunk 1: ID=2, 89 chars
2025-04-09 22:22:13,416 - TestPolicyChunking - INFO - Created chunk 2: ID=3, 89 chars
2025-04-09 22:22:13,419 - TestPolicyChunking - INFO - Retrieved 3 chunks for policy
2025-04-09 22:22:13,422 - TestPolicyChunking - INFO - Text search for 'guideline' returned 1 results
2025-04-09 22:22:13,423 - TestPolicyChunking - INFO -   Result 0: score=0.0890, content=# Test Policy Document
            
            ##...
2025-04-09 22:22:13,425 - TestPolicyChunking - INFO - Text search for 'compliance' returned 1 results
2025-04-09 22:22:13,425 - TestPolicyChunking - INFO -   Result 0: score=0.0760, content=# Test Policy Document
            
            ##...
2025-04-09 22:22:13,427 - TestPolicyChunking - INFO - Text search for 'introduction' returned 1 results
2025-04-09 22:22:13,427 - TestPolicyChunking - INFO -   Result 0: score=0.0608, content=# Test Policy Document
            
            ##...
2025-04-09 22:22:13,430 - TestPolicyChunking - INFO - Embedding search returned 1 results
2025-04-09 22:22:13,431 - TestPolicyChunking - INFO -   Result 0: similarity=1.0000, content=# Test Policy Document
            
            ##...
2025-04-09 22:22:13,433 - TestPolicyChunking - INFO - Modified embedding search returned 1 results
2025-04-09 22:22:13,433 - TestPolicyChunking - INFO - Original similarity: 1.0000, Modified similarity: 0.6473
2025-04-09 22:22:13,434 - TestPolicyChunking - INFO - Confirmed exact match has higher similarity than modified embedding
2025-04-09 22:22:13,437 - TestPolicyChunking - INFO - Baseline results: 1, Higher threshold (0.9500) results: 1
2025-04-09 22:22:13,438 - TestPolicyChunking - INFO - Confirmed similarity threshold filtering works correctly
2025-04-09 22:22:13,440 - TestPolicyChunking - INFO - Hybrid search returned 1 results
2025-04-09 22:22:13,440 - TestPolicyChunking - INFO -   Result 0: combined=0.8178, text=0.0890, vector=1.0000
2025-04-09 22:22:13,444 - TestPolicyChunking - INFO - Retrieved neighbors for chunk 2 (index 1)
2025-04-09 22:22:13,445 - TestPolicyChunking - INFO -   Previous chunks: [1]
2025-04-09 22:22:13,445 - TestPolicyChunking - INFO -   Next chunks: [3]
2025-04-09 22:22:13,449 - TestPolicyChunking - INFO - Retrieved 1 unique policies from chunk results
2025-04-09 22:22:13,450 - TestPolicyChunking - INFO - Test successful: committed all changes
2025-04-09 22:22:13,454 - TestPolicyChunking - INFO - Testing comprehensive repository functions...
2025-04-09 22:22:13,455 - TestPolicyChunking - WARNING - is_active field not present in User model, continuing without it
2025-04-09 22:22:13,466 - TestPolicyChunking - INFO - Created users: admin=1, regular=2, inactive=3
2025-04-09 22:22:13,468 - TestPolicyChunking - INFO - Skipping username tests as User model uses email for identification
2025-04-09 22:22:13,469 - TestPolicyChunking - WARNING - Authentication method has incompatible signature, skipping test
2025-04-09 22:22:13,477 - TestPolicyChunking - INFO - Created policy 0: ID=2
2025-04-09 22:22:13,478 - TestPolicyChunking - INFO - Created policy 1: ID=3
2025-04-09 22:22:13,479 - TestPolicyChunking - INFO - Created policy 2: ID=4
2025-04-09 22:22:13,483 - TestPolicyChunking - INFO - Skipping get_policy_details test due to issues with selectinload.order_by
2025-04-09 22:22:13,484 - TestPolicyChunking - INFO - Full text search found 4 results
2025-04-09 22:22:13,489 - TestPolicyChunking - INFO - Found 1 update history records
2025-04-09 22:22:13,510 - TestPolicyChunking - INFO - All repository function tests completed successfully
2025-04-09 22:22:13,515 - TestPolicyChunking - INFO - All policy chunking and embedding tests passed successfully!
2025-04-09 22:22:13,515 - TestPolicyChunking - INFO - Connecting to admin database to drop ydrpolicy_test
2025-04-09 22:22:13,523 - TestPolicyChunking - INFO - Terminating all connections to ydrpolicy_test
2025-04-09 22:22:14,027 - TestPolicyChunking - INFO - Dropping database ydrpolicy_test
2025-04-09 22:22:14,132 - TestPolicyChunking - INFO - Dropped database ydrpolicy_test
2025-04-09 23:16:26,589 - TestPolicyChunking - INFO - Backend logging initialized. Log file: /Users/pouria/Documents/Coding/YDRP-RAG/tests/backend/database/logs/test_policy_chunking.log
2025-04-09 23:16:26,590 - TestPolicyChunking - INFO - Connecting to admin database to drop ydrpolicy_test
2025-04-09 23:16:26,613 - TestPolicyChunking - INFO - Database ydrpolicy_test does not exist
2025-04-09 23:16:26,618 - TestPolicyChunking - INFO - Connecting to admin database to create ydrpolicy_test
2025-04-09 23:16:26,684 - TestPolicyChunking - INFO - Created database ydrpolicy_test
2025-04-09 23:16:26,687 - TestPolicyChunking - INFO - Setting up database at postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy_test
2025-04-09 23:16:26,695 - TestPolicyChunking - INFO - Connection test result: 1
2025-04-09 23:16:26,704 - TestPolicyChunking - INFO - Vector extension created or exists
2025-04-09 23:16:26,734 - TestPolicyChunking - INFO - Tables created
2025-04-09 23:16:26,738 - TestPolicyChunking - INFO - Search vector triggers created
2025-04-09 23:16:26,742 - TestPolicyChunking - INFO - Testing chunking functionality...
2025-04-09 23:16:26,743 - TestPolicyChunking - INFO - Chunked text with size=50: 18 chunks produced
2025-04-09 23:16:26,743 - TestPolicyChunking - INFO -   Chunk 0: 25 chars: This is a test paragraph....
2025-04-09 23:16:26,744 - TestPolicyChunking - INFO -   Chunk 1: 50 chars: This is another paragraph with...
2025-04-09 23:16:26,744 - TestPolicyChunking - INFO -   Chunk 2: 27 chars: ent that should be chunked....
2025-04-09 23:16:26,744 - TestPolicyChunking - INFO -   Chunk 3: 10 chars: e chunked....
2025-04-09 23:16:26,745 - TestPolicyChunking - INFO -   Chunk 4: 50 chars: It includes
    multiple sente...
2025-04-09 23:16:26,745 - TestPolicyChunking - INFO -   Chunk 5: 27 chars: st sentence-level chunking....
2025-04-09 23:16:26,746 - TestPolicyChunking - INFO -   Chunk 6: 10 chars:  chunking....
2025-04-09 23:16:26,746 - TestPolicyChunking - INFO -   Chunk 7: 50 chars: Each sentence should ideally
 ...
2025-04-09 23:16:26,746 - TestPolicyChunking - INFO -   Chunk 8: 31 chars:  together unless it's too long...
2025-04-09 23:16:26,747 - TestPolicyChunking - INFO -   Chunk 9: 10 chars:  too long....
2025-04-09 23:16:26,747 - TestPolicyChunking - INFO -   Chunk 10: 10 chars:  too long....
2025-04-09 23:16:26,747 - TestPolicyChunking - INFO -   Chunk 11: 50 chars: A third paragraph begins here ...
2025-04-09 23:16:26,748 - TestPolicyChunking - INFO -   Chunk 12: 28 chars: ues with additional content....
2025-04-09 23:16:26,748 - TestPolicyChunking - INFO -   Chunk 13: 10 chars: l content....
2025-04-09 23:16:26,748 - TestPolicyChunking - INFO -   Chunk 14: 50 chars: This paragraph also has multip...
2025-04-09 23:16:26,748 - TestPolicyChunking - INFO -   Chunk 15: 33 chars: es for testing chunking behavi...
2025-04-09 23:16:26,749 - TestPolicyChunking - INFO -   Chunk 16: 10 chars:  behavior....
2025-04-09 23:16:26,749 - TestPolicyChunking - INFO -   Chunk 17: 10 chars:  behavior....
2025-04-09 23:16:26,749 - TestPolicyChunking - INFO - Chunked text with size=100: 9 chunks produced
2025-04-09 23:16:26,750 - TestPolicyChunking - INFO -   Chunk 0: 25 chars: This is a test paragraph....
2025-04-09 23:16:26,750 - TestPolicyChunking - INFO -   Chunk 1: 67 chars: This is another paragraph with...
2025-04-09 23:16:26,750 - TestPolicyChunking - INFO -   Chunk 2: 67 chars: It includes
    multiple sente...
2025-04-09 23:16:26,751 - TestPolicyChunking - INFO -   Chunk 3: 82 chars:  chunking. Each sentence shoul...
2025-04-09 23:16:26,751 - TestPolicyChunking - INFO -   Chunk 4: 10 chars:  too long....
2025-04-09 23:16:26,751 - TestPolicyChunking - INFO -   Chunk 5: 68 chars: A third paragraph begins here ...
2025-04-09 23:16:26,751 - TestPolicyChunking - INFO -   Chunk 6: 73 chars: This paragraph also has multip...
2025-04-09 23:16:26,752 - TestPolicyChunking - INFO -   Chunk 7: 10 chars:  behavior....
2025-04-09 23:16:26,752 - TestPolicyChunking - INFO -   Chunk 8: 10 chars:  behavior....
2025-04-09 23:16:26,752 - TestPolicyChunking - INFO - Chunked text with size=200: 5 chunks produced
2025-04-09 23:16:26,753 - TestPolicyChunking - INFO -   Chunk 0: 25 chars: This is a test paragraph....
2025-04-09 23:16:26,753 - TestPolicyChunking - INFO -   Chunk 1: 135 chars: This is another paragraph with...
2025-04-09 23:16:26,753 - TestPolicyChunking - INFO -   Chunk 2: 71 chars: Each sentence should ideally
 ...
2025-04-09 23:16:26,754 - TestPolicyChunking - INFO -   Chunk 3: 10 chars:  too long....
2025-04-09 23:16:26,754 - TestPolicyChunking - INFO -   Chunk 4: 162 chars:  too long.

    A third paragr...
2025-04-09 23:16:26,755 - TestPolicyChunking - INFO - Chunked markdown: 5 chunks produced
2025-04-09 23:16:26,755 - TestPolicyChunking - INFO -   MD Chunk 0: 0 chars: ...
2025-04-09 23:16:26,755 - TestPolicyChunking - INFO -   MD Chunk 1: 53 chars: # Heading 1
    
    This is c...
2025-04-09 23:16:26,756 - TestPolicyChunking - INFO -   MD Chunk 2: 100 chars: ## Heading 1.1
    
    This i...
2025-04-09 23:16:26,756 - TestPolicyChunking - INFO -   MD Chunk 3: 31 chars: his is content under heading 2...
2025-04-09 23:16:26,756 - TestPolicyChunking - INFO -   MD Chunk 4: 69 chars: heading 2. ## Heading 2.1
    ...
2025-04-09 23:16:26,757 - TestPolicyChunking - INFO - Testing embedding functionality...
2025-04-09 23:16:27,148 - TestPolicyChunking - INFO - Generated embedding for single text: 1536 dimensions
2025-04-09 23:16:27,561 - TestPolicyChunking - INFO - Generated 3 embeddings in batch mode
2025-04-09 23:16:27,562 - TestPolicyChunking - INFO -   Embedding 0: 1536 dimensions
2025-04-09 23:16:27,562 - TestPolicyChunking - INFO -   Embedding 1: 1536 dimensions
2025-04-09 23:16:27,563 - TestPolicyChunking - INFO -   Embedding 2: 1536 dimensions
2025-04-09 23:16:27,563 - TestPolicyChunking - INFO - Testing policy chunking and embedding DB integration
2025-04-09 23:16:27,604 - TestPolicyChunking - INFO - Created test policy with ID: 1
2025-04-09 23:16:27,605 - TestPolicyChunking - INFO - Split policy into 3 chunks
2025-04-09 23:16:28,403 - TestPolicyChunking - INFO - Generated 3 embeddings
2025-04-09 23:16:28,433 - TestPolicyChunking - INFO - Created chunk 0: ID=1, 959 chars
2025-04-09 23:16:28,440 - TestPolicyChunking - INFO - Created chunk 1: ID=2, 89 chars
2025-04-09 23:16:28,447 - TestPolicyChunking - INFO - Created chunk 2: ID=3, 89 chars
2025-04-09 23:16:28,452 - TestPolicyChunking - INFO - Retrieved 3 chunks for policy
2025-04-09 23:16:28,457 - TestPolicyChunking - INFO - Text search for 'guideline' returned 1 results
2025-04-09 23:16:28,458 - TestPolicyChunking - INFO -   Result 0: score=0.0890, content=# Test Policy Document
            
            ##...
2025-04-09 23:16:28,462 - TestPolicyChunking - INFO - Text search for 'compliance' returned 1 results
2025-04-09 23:16:28,462 - TestPolicyChunking - INFO -   Result 0: score=0.0760, content=# Test Policy Document
            
            ##...
2025-04-09 23:16:28,464 - TestPolicyChunking - INFO - Text search for 'introduction' returned 1 results
2025-04-09 23:16:28,465 - TestPolicyChunking - INFO -   Result 0: score=0.0608, content=# Test Policy Document
            
            ##...
2025-04-09 23:16:28,468 - TestPolicyChunking - INFO - Embedding search returned 1 results
2025-04-09 23:16:28,468 - TestPolicyChunking - INFO -   Result 0: similarity=1.0000, content=# Test Policy Document
            
            ##...
2025-04-09 23:16:28,472 - TestPolicyChunking - INFO - Modified embedding search returned 1 results
2025-04-09 23:16:28,473 - TestPolicyChunking - INFO - Original similarity: 1.0000, Modified similarity: 0.6685
2025-04-09 23:16:28,474 - TestPolicyChunking - INFO - Confirmed exact match has higher similarity than modified embedding
2025-04-09 23:16:28,479 - TestPolicyChunking - INFO - Baseline results: 1, Higher threshold (0.9500) results: 1
2025-04-09 23:16:28,479 - TestPolicyChunking - INFO - Confirmed similarity threshold filtering works correctly
2025-04-09 23:16:28,483 - TestPolicyChunking - INFO - Hybrid search returned 1 results
2025-04-09 23:16:28,483 - TestPolicyChunking - INFO -   Result 0: combined=0.8178, text=0.0890, vector=1.0000
2025-04-09 23:16:28,487 - TestPolicyChunking - INFO - Retrieved neighbors for chunk 2 (index 1)
2025-04-09 23:16:28,487 - TestPolicyChunking - INFO -   Previous chunks: [1]
2025-04-09 23:16:28,487 - TestPolicyChunking - INFO -   Next chunks: [3]
2025-04-09 23:16:28,491 - TestPolicyChunking - INFO - Retrieved 1 unique policies from chunk results
2025-04-09 23:16:28,493 - TestPolicyChunking - INFO - Test successful: committed all changes
2025-04-09 23:16:28,498 - TestPolicyChunking - INFO - Testing comprehensive repository functions...
2025-04-09 23:16:28,499 - TestPolicyChunking - WARNING - is_active field not present in User model, continuing without it
2025-04-09 23:16:28,513 - TestPolicyChunking - INFO - Created users: admin=1, regular=2, inactive=3
2025-04-09 23:16:28,515 - TestPolicyChunking - INFO - Skipping username tests as User model uses email for identification
2025-04-09 23:16:28,516 - TestPolicyChunking - WARNING - Authentication method has incompatible signature, skipping test
2025-04-09 23:16:28,524 - TestPolicyChunking - INFO - Created policy 0: ID=2
2025-04-09 23:16:28,526 - TestPolicyChunking - INFO - Created policy 1: ID=3
2025-04-09 23:16:28,527 - TestPolicyChunking - INFO - Created policy 2: ID=4
2025-04-09 23:16:28,532 - TestPolicyChunking - INFO - Skipping get_policy_details test due to issues with selectinload.order_by
2025-04-09 23:16:28,533 - TestPolicyChunking - INFO - Full text search found 4 results
2025-04-09 23:16:28,540 - TestPolicyChunking - INFO - Found 1 update history records
2025-04-09 23:16:28,563 - TestPolicyChunking - INFO - All repository function tests completed successfully
2025-04-09 23:16:28,568 - TestPolicyChunking - INFO - All policy chunking and embedding tests passed successfully!
2025-04-09 23:16:28,568 - TestPolicyChunking - INFO - Connecting to admin database to drop ydrpolicy_test
2025-04-09 23:16:28,578 - TestPolicyChunking - INFO - Terminating all connections to ydrpolicy_test
2025-04-09 23:16:29,082 - TestPolicyChunking - INFO - Dropping database ydrpolicy_test
2025-04-09 23:16:29,193 - TestPolicyChunking - INFO - Dropped database ydrpolicy_test
