2025-04-14 01:22:10,605 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 01:22:10,606 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 01:22:10,606 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 01:22:23,424 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 01:22:23,424 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 01:22:23,424 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 01:22:23,425 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 01:22:23,427 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 01:22:23,428 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 01:22:23,428 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 01:22:23,428 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 01:22:23,428 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 01:22:23,429 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 01:22:31,880 - ydrpolicy.backend.agent.terminal - ERROR - Agent run error: Server not initialized. Make sure you call `connect()` first.
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 505, in terminal_chat
    async for event in result_stream.stream_events():
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/result.py", line 186, in stream_events
    raise self._stored_exception
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/run.py", line 518, in _run_streamed_impl
    all_tools = await cls._get_all_tools(current_agent)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/run.py", line 931, in _get_all_tools
    return await agent.get_all_tools()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/agent.py", line 231, in get_all_tools
    mcp_tools = await self.get_mcp_tools()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/agent.py", line 227, in get_mcp_tools
    return await MCPUtil.get_all_function_tools(self.mcp_servers)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/mcp/util.py", line 27, in get_all_function_tools
    server_tools = await cls.get_function_tools(server)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/mcp/util.py", line 44, in get_function_tools
    tools = await server.list_tools()
            ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/mcp/server.py", line 115, in list_tools
    raise UserError("Server not initialized. Make sure you call `connect()` first.")
agents.exceptions.UserError: Server not initialized. Make sure you call `connect()` first.
2025-04-14 01:22:31,984 - ydrpolicy.backend.agent.terminal - WARNING - Keeping previous history list due to agent run failure.
2025-04-14 01:22:44,895 - ydrpolicy.backend.mcp.server - INFO - MCP server process finished.
2025-04-14 01:22:44,897 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 01:22:50,204 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 01:22:50,204 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 01:22:50,204 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 01:22:54,867 - ydrpolicy.backend.agent.mcp_connection - INFO - Closing MCP server connection...
2025-04-14 01:22:54,869 - ydrpolicy.backend.agent.mcp_connection - INFO - MCP server connection closed.
2025-04-14 01:22:54,870 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 01:22:54,871 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 01:22:57,857 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 01:22:57,857 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 01:22:57,857 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 01:22:57,857 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 01:22:57,858 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 01:22:57,858 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 01:22:57,858 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 01:22:57,859 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 01:22:57,859 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 01:22:57,859 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 01:23:00,124 - ydrpolicy.backend.agent.terminal - ERROR - Agent run error: Server not initialized. Make sure you call `connect()` first.
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 505, in terminal_chat
    async for event in result_stream.stream_events():
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/result.py", line 186, in stream_events
    raise self._stored_exception
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/run.py", line 518, in _run_streamed_impl
    all_tools = await cls._get_all_tools(current_agent)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/run.py", line 931, in _get_all_tools
    return await agent.get_all_tools()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/agent.py", line 231, in get_all_tools
    mcp_tools = await self.get_mcp_tools()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/agent.py", line 227, in get_mcp_tools
    return await MCPUtil.get_all_function_tools(self.mcp_servers)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/mcp/util.py", line 27, in get_all_function_tools
    server_tools = await cls.get_function_tools(server)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/mcp/util.py", line 44, in get_function_tools
    tools = await server.list_tools()
            ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/mcp/server.py", line 115, in list_tools
    raise UserError("Server not initialized. Make sure you call `connect()` first.")
agents.exceptions.UserError: Server not initialized. Make sure you call `connect()` first.
2025-04-14 01:23:00,226 - ydrpolicy.backend.agent.terminal - WARNING - Keeping previous history list due to agent run failure.
2025-04-14 01:25:42,196 - ydrpolicy.backend.mcp.server - INFO - MCP server process finished.
2025-04-14 01:25:42,198 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 01:25:45,355 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 01:25:45,356 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 01:25:45,356 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 01:25:52,533 - ydrpolicy.backend.agent.mcp_connection - INFO - Closing MCP server connection...
2025-04-14 01:25:52,535 - ydrpolicy.backend.agent.mcp_connection - INFO - MCP server connection closed.
2025-04-14 01:25:52,535 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 01:25:52,536 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 01:25:55,475 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 01:25:55,476 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 01:25:55,476 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 01:25:55,476 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 01:25:55,477 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 01:25:55,477 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 01:25:55,477 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 01:25:55,478 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 01:25:55,478 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 01:25:55,478 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 01:25:58,644 - ydrpolicy.backend.agent.terminal - ERROR - Agent run error: Server not initialized. Make sure you call `connect()` first.
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 505, in terminal_chat
    async for event in result_stream.stream_events():
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/result.py", line 186, in stream_events
    raise self._stored_exception
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/run.py", line 518, in _run_streamed_impl
    all_tools = await cls._get_all_tools(current_agent)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/run.py", line 931, in _get_all_tools
    return await agent.get_all_tools()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/agent.py", line 231, in get_all_tools
    mcp_tools = await self.get_mcp_tools()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/agent.py", line 227, in get_mcp_tools
    return await MCPUtil.get_all_function_tools(self.mcp_servers)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/mcp/util.py", line 27, in get_all_function_tools
    server_tools = await cls.get_function_tools(server)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/mcp/util.py", line 44, in get_function_tools
    tools = await server.list_tools()
            ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/mcp/server.py", line 115, in list_tools
    raise UserError("Server not initialized. Make sure you call `connect()` first.")
agents.exceptions.UserError: Server not initialized. Make sure you call `connect()` first.
2025-04-14 01:25:58,745 - ydrpolicy.backend.agent.terminal - WARNING - Keeping previous history list due to agent run failure.
2025-04-14 01:28:04,909 - ydrpolicy.backend.mcp.server - INFO - MCP server process finished.
2025-04-14 01:28:04,911 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 01:28:07,546 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 01:28:07,546 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 01:28:07,547 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 01:28:12,401 - ydrpolicy.backend.agent.mcp_connection - INFO - Closing MCP server connection...
2025-04-14 01:28:12,402 - ydrpolicy.backend.agent.mcp_connection - INFO - MCP server connection closed.
2025-04-14 01:28:12,403 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 01:28:15,130 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 01:28:15,130 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 01:28:15,130 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 01:28:15,130 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 01:28:15,132 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 01:28:15,132 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 01:28:15,133 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 01:28:15,133 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 01:28:15,133 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 01:28:15,133 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 01:29:48,916 - ydrpolicy.backend.mcp.server - INFO - MCP server process finished.
2025-04-14 01:29:48,918 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 01:29:52,310 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 01:29:52,310 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 01:29:52,310 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 01:29:55,422 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 01:29:57,738 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 01:29:57,738 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 01:29:57,738 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 01:29:57,739 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 01:29:57,739 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 01:29:57,739 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 01:29:57,740 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 01:29:57,740 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 01:29:57,740 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 01:29:57,741 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 01:29:57,762 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connected.
2025-04-14 01:30:28,265 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='MRI contrasts policy...', k=5, threshold=None
2025-04-14 01:30:28,821 - ydrpolicy.backend.database.engine - INFO - Creating new database engine
2025-04-14 01:30:28,851 - ydrpolicy.backend.database.engine - INFO - Database engine created successfully
2025-04-14 01:30:28,852 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 01:30:28,904 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 01:30:28,910 - ydrpolicy.backend.agent.terminal - ERROR - Stream processing error: 'ToolCallItem' object has no attribute 'tool_call'
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 410, in terminal_chat
    f"\n[Calling tool: {event.item.tool_call.function.name}...]",
                        ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'ToolCallItem' object has no attribute 'tool_call'
2025-04-14 01:30:28,947 - ydrpolicy.backend.agent.terminal - WARNING - Keeping previous history list due to agent run failure.
2025-04-14 01:53:44,342 - ydrpolicy.backend.agent.terminal - ERROR - Terminal Mode: MCP close error: 'MCPServerSse' object has no attribute 'close'
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 477, in terminal_chat
AttributeError: 'MCPServerSse' object has no attribute 'close'
2025-04-14 01:53:44,381 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 01:53:44,442 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 01:57:39,030 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 01:57:39,030 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 01:57:39,030 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 01:57:39,031 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 01:57:39,032 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 01:57:39,032 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 01:57:39,032 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 01:57:39,033 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 01:57:39,033 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 01:57:39,033 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 01:57:39,054 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connected.
2025-04-14 01:58:34,262 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='contrast coverage...', k=5, threshold=None
2025-04-14 01:58:34,891 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 01:58:34,900 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 01:58:34,910 - ydrpolicy.backend.agent.terminal - WARNING - Could not find name via item.raw_item.function.name in tool_call_item.
2025-04-14 01:58:47,057 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='contrast agent coverage radiology...', k=5, threshold=None
2025-04-14 01:58:47,591 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 01:58:47,600 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 01:58:47,607 - ydrpolicy.backend.agent.terminal - WARNING - Could not find name via item.raw_item.function.name in tool_call_item.
2025-04-14 01:58:55,082 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='contrast agent coverage Yale Diagnostic Radiology...', k=5, threshold=None
2025-04-14 01:58:55,577 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 01:58:55,586 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 01:58:55,596 - ydrpolicy.backend.agent.terminal - WARNING - Could not find name via item.raw_item.function.name in tool_call_item.
2025-04-14 01:59:04,727 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='contrast agent coverage radiology guidelines...', k=5, threshold=None
2025-04-14 01:59:05,203 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 01:59:05,211 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 01:59:05,220 - ydrpolicy.backend.agent.terminal - WARNING - Could not find name via item.raw_item.function.name in tool_call_item.
2025-04-14 01:59:05,901 - ydrpolicy.backend.agent.terminal - ERROR - Terminal Mode: MCP close error: 'MCPServerSse' object has no attribute 'close'
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 365, in terminal_chat
    user_input = input("You: ")
                 ^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 157, in _on_sigint
    raise KeyboardInterrupt()
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 464, in terminal_chat
    term_logger.info("Interrupt received")
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/logging/__init__.py", line 1539, in info
    self._log(INFO, msg, args, **kwargs)
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/logging/__init__.py", line 1682, in _log
    record = self.makeRecord(self.name, level, fn, lno, msg, args,
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/logging/__init__.py", line 1651, in makeRecord
    rv = _logRecordFactory(name, level, fn, lno, msg, args, exc_info, func,
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/logging/__init__.py", line 328, in __init__
    self.levelname = getLevelName(level)
                     ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/logging/__init__.py", line 148, in getLevelName
    result = _levelToName.get(level)
             ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 157, in _on_sigint
    raise KeyboardInterrupt()
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 479, in terminal_chat
    await mcp_server_instance.close() # Close explicitly
          ^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MCPServerSse' object has no attribute 'close'
2025-04-14 01:59:06,084 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:02:47,235 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:02:47,235 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:02:47,235 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:02:47,236 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:02:47,237 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:02:47,237 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:02:47,237 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:02:47,238 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:02:47,238 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:02:47,238 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:02:47,259 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connected.
2025-04-14 02:03:00,933 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='What is the Yale policy on contrast coverage?...', k=5, threshold=None
2025-04-14 02:03:01,542 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:03:01,587 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:03:01,598 - ydrpolicy.backend.agent.terminal - WARNING - Could not find name via item.raw_item.function.name in tool_call_item.
2025-04-14 02:03:08,613 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='contrast coverage Yale Radiology policy...', k=5, threshold=None
2025-04-14 02:03:09,428 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:03:09,439 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:03:09,447 - ydrpolicy.backend.agent.terminal - WARNING - Could not find name via item.raw_item.function.name in tool_call_item.
2025-04-14 02:03:14,967 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='contrast coverage radiology policy Yale...', k=5, threshold=None
2025-04-14 02:03:15,528 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:03:15,540 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:03:15,549 - ydrpolicy.backend.agent.terminal - WARNING - Could not find name via item.raw_item.function.name in tool_call_item.
2025-04-14 02:03:20,396 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='contrast coverage diagnostic radiology policy Yale...', k=5, threshold=None
2025-04-14 02:03:20,884 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:03:20,894 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:03:20,903 - ydrpolicy.backend.agent.terminal - WARNING - Could not find name via item.raw_item.function.name in tool_call_item.
2025-04-14 02:05:31,305 - ydrpolicy.backend.agent.terminal - ERROR - Terminal Mode: MCP close error: 'MCPServerSse' object has no attribute 'close'
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 479, in terminal_chat
    await mcp_server_instance.close() # Close explicitly
          ^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MCPServerSse' object has no attribute 'close'
2025-04-14 02:05:31,361 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:05:31,415 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 02:05:42,689 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:05:42,689 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:05:42,690 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:05:42,690 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:05:42,690 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:05:42,691 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:05:42,691 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:05:42,691 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:05:42,692 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:05:42,692 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:05:42,711 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connected.
2025-04-14 02:06:05,586 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='resident shifts on high volume hours Yale policy...', k=5, threshold=None
2025-04-14 02:06:05,981 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:06:05,991 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:06:06,001 - ydrpolicy.backend.agent.terminal - WARNING - Could not find name via item.raw_item.function.name in tool_call_item.
2025-04-14 02:06:09,567 - ydrpolicy.backend.mcp.server - INFO - Received get_policy_from_ID request for policy_id: 2
2025-04-14 02:06:09,598 - ydrpolicy.backend.agent.terminal - WARNING - Could not find name via item.raw_item.function.name in tool_call_item.
2025-04-14 02:09:28,910 - ydrpolicy.backend.agent.terminal - ERROR - Terminal Mode: MCP close error: 'MCPServerSse' object has no attribute 'close'
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
    self.run_forever()
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
    self._run_once()
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 1961, in _run_once
    event_list = self._selector.select(timeout)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/selectors.py", line 566, in select
    kev_list = self._selector.control(None, max_ev, timeout)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 157, in _on_sigint
    raise KeyboardInterrupt()
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    future.remove_done_callback(_run_until_complete_cb)
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 157, in _on_sigint
    raise KeyboardInterrupt()
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 307, in terminal_chat
    log_disabled = ctx.meta["log_disabled"]
                                     ^^^^^^^
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 409, in terminal_chat
    # ******************** FINAL CORRECTED ACCESS ********************
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/logging/__init__.py", line 1539, in info
    self._log(INFO, msg, args, **kwargs)
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/logging/__init__.py", line 1682, in _log
    record = self.makeRecord(self.name, level, fn, lno, msg, args,
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/logging/__init__.py", line 1651, in makeRecord
    rv = _logRecordFactory(name, level, fn, lno, msg, args, exc_info, func,
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/logging/__init__.py", line 333, in __init__
    self.module = os.path.splitext(self.filename)[0]
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen posixpath>", line 125, in splitext
  File "<frozen genericpath>", line 133, in _splitext
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 423, in terminal_chat
AttributeError: 'MCPServerSse' object has no attribute 'close'
2025-04-14 02:09:32,278 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:09:32,278 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:09:32,278 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:09:32,279 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:09:32,279 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:09:32,279 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:09:32,280 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:09:32,280 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:09:32,280 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:09:32,280 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:09:32,301 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connected.
2025-04-14 02:09:36,721 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='Yale policy on resident shifts on high volume hour...', k=5, threshold=None
2025-04-14 02:09:37,333 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:09:37,343 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:09:41,022 - ydrpolicy.backend.mcp.server - INFO - Received get_policy_from_ID request for policy_id: 2
2025-04-14 02:09:49,275 - ydrpolicy.backend.agent.terminal - ERROR - Terminal Mode: MCP close error: 'MCPServerSse' object has no attribute 'close'
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 481, in terminal_chat
    await mcp_server_instance.close() # Close explicitly
          ^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MCPServerSse' object has no attribute 'close'
2025-04-14 02:09:49,329 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:09:49,385 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 02:12:22,970 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:12:22,970 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:12:22,970 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:12:22,971 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:12:22,971 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:12:22,971 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:12:22,972 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:12:22,972 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:12:22,972 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:12:22,973 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:12:22,994 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connection established via async context.
2025-04-14 02:12:25,069 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:12:25,071 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 02:12:28,757 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:12:28,758 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:12:28,758 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:12:28,758 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:12:28,759 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:12:28,759 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:12:28,759 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:12:28,759 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:12:28,760 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:12:28,760 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:12:28,780 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connection established via async context.
2025-04-14 02:12:45,576 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='Yale policy on resident shifts on high volume hour...', k=5, threshold=None
2025-04-14 02:12:45,950 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:12:45,959 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:12:53,562 - ydrpolicy.backend.mcp.server - INFO - Received get_policy_from_ID request for policy_id: 2
2025-04-14 02:13:00,398 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:13:00,401 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 02:13:09,270 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:13:09,271 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:13:09,271 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Disabled
2025-04-14 02:13:09,271 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:13:09,272 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: False)...
2025-04-14 02:13:09,272 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:13:09,273 - ydrpolicy.backend.agent.terminal - CRITICAL - Terminal agent start failed: 'coroutine' object does not support the asynchronous context manager protocol
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 351, in terminal_chat
    async with mcp_server_instance if mcp_server_instance and isinstance(mcp_server_instance, MCPServerSse) else asyncio.sleep(0) as active_mcp_connection: # type: ignore
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: 'coroutine' object does not support the asynchronous context manager protocol
2025-04-14 02:13:09,297 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:13:09,297 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 02:15:24,600 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:15:24,600 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:15:24,600 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Disabled
2025-04-14 02:15:24,601 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:15:24,601 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: False)...
2025-04-14 02:15:24,601 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:15:33,170 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:15:33,172 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 02:15:38,514 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:15:38,515 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:15:38,515 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:15:38,515 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:15:38,516 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:15:38,516 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:15:38,516 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:15:38,517 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:15:38,517 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:15:38,517 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:15:38,537 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connection established via async context.
2025-04-14 02:15:56,320 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='resident shift during high volume hours policy...', k=5, threshold=None
2025-04-14 02:15:56,554 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:15:56,566 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:15:59,842 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='resident shift high volume hours diagnostic radiol...', k=5, threshold=None
2025-04-14 02:16:00,451 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:16:00,460 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:16:08,313 - ydrpolicy.backend.mcp.server - INFO - Received get_policy_from_ID request for policy_id: 2
2025-04-14 02:16:19,725 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:16:19,727 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 02:16:24,086 - ydrpolicy.backend.mcp.server - INFO - MCP server process finished.
2025-04-14 02:16:24,087 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 02:16:27,599 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 02:16:27,599 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 02:16:27,600 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 02:16:28,530 - ydrpolicy.backend.mcp.server - INFO - MCP server process finished.
2025-04-14 02:16:28,533 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 02:16:33,671 - ydrpolicy.backend.mcp - WARNING - Running MCP in stdio mode with console logging potentially enabled (if --no-log not used). Attempting to disable console handler dynamically.
2025-04-14 02:16:33,672 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via stdio transport...
2025-04-14 02:16:33,672 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using stdio transport...
2025-04-14 02:16:33,672 - ydrpolicy.backend.mcp.server - INFO - Configuring logger for stdio mode (disabling console handler)...
2025-04-14 02:16:33,673 - ydrpolicy.backend.mcp.server - INFO - Removed RichHandler: <RichHandler (INFO)>
2025-04-14 02:16:33,673 - ydrpolicy.backend.mcp.server - INFO - Console logging disabled for stdio mode.
2025-04-14 02:16:33,673 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with stdio transport.
2025-04-14 02:16:34,981 - ydrpolicy.backend.mcp - INFO - MCP server startup interrupted by user.
2025-04-14 02:16:34,982 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 02:19:10,608 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 02:19:10,609 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 02:19:10,609 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 02:22:44,259 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:22:44,259 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:22:44,259 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:22:44,260 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:22:44,260 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:22:44,261 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:22:44,261 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:22:44,261 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:22:44,261 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:22:44,261 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:22:44,283 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connection established via async context.
2025-04-14 02:23:04,680 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='Yale policy on resident shifts during high volume ...', k=5, threshold=None
2025-04-14 02:23:04,990 - ydrpolicy.backend.database.engine - INFO - Creating new database engine
2025-04-14 02:23:05,004 - ydrpolicy.backend.database.engine - INFO - Database engine created successfully
2025-04-14 02:23:05,004 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:23:05,041 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:23:35,678 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:23:35,681 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 02:23:41,273 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:23:41,274 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:23:41,274 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Disabled
2025-04-14 02:23:41,274 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:23:41,275 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: False)...
2025-04-14 02:23:41,275 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:23:52,688 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:23:52,692 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 02:24:23,332 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:24:23,332 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:24:23,333 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:24:23,333 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:24:28,352 - ydrpolicy.backend.agent - ERROR - MCP server check FAILED at http://localhost:8001/sse: 
Ensure MCP server is running with '--transport http' and accessible.
2025-04-14 02:26:35,631 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:26:35,631 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:26:35,631 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:26:35,632 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:26:35,632 - ydrpolicy.backend.agent - INFO - Waiting 2s for MCP server to initialize before checking...
2025-04-14 02:26:42,670 - ydrpolicy.backend.agent - ERROR - MCP server check FAILED at http://localhost:8001/sse: 
Ensure MCP server is running with '--transport http' and accessible.
2025-04-14 02:28:43,370 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:28:43,370 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:28:43,370 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:28:43,371 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:28:43,371 - ydrpolicy.backend.agent - INFO - Waiting 2s for MCP server to initialize before checking...
2025-04-14 02:28:55,419 - ydrpolicy.backend.agent - ERROR - MCP server check FAILED at http://localhost:8001/sse: 
Ensure MCP server is running with '--transport http' and accessible on port 8001.
2025-04-14 02:30:40,253 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:30:40,253 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:30:40,253 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:30:40,254 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:30:40,254 - ydrpolicy.backend.agent - INFO - Waiting 2s for MCP server to initialize before checking...
2025-04-14 02:30:52,301 - ydrpolicy.backend.agent - ERROR - MCP server check FAILED at 127.0.0.1: 
Ensure MCP server is running with '--transport http' and accessible on port 8001.
2025-04-14 02:35:00,650 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:35:00,651 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:35:00,651 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:35:00,651 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:35:00,770 - ydrpolicy.backend.agent - CRITICAL - Failed to start FastAPI server: cannot import name 'ToolCallItem' from 'agents.stream_events' (/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/stream_events.py)
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 418, in agent_command
    uvicorn.run(
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/main.py", line 579, in run
    server.run()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 66, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 70, in serve
    await self._serve(sockets)
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 77, in _serve
    config.load()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/config.py", line 435, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 999, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/api_main.py", line 12, in <module>
    from ydrpolicy.backend.routers import chat as chat_router  # Import the chat router
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/routers/chat.py", line 16, in <module>
    from ydrpolicy.backend.services.chat_service import ChatService
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/services/chat_service.py", line 24, in <module>
    from agents.stream_events import (
ImportError: cannot import name 'ToolCallItem' from 'agents.stream_events' (/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/stream_events.py)
2025-04-14 02:36:58,324 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:36:58,324 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:36:58,325 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:36:58,325 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:36:58,325 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:36:58,326 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:36:58,326 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:36:58,326 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:36:58,327 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:36:58,327 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:36:58,347 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connection established via async context.
2025-04-14 02:37:15,119 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='resident shift during high volume hours Yale polic...', k=5, threshold=None
2025-04-14 02:37:15,332 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:37:15,344 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:37:20,644 - ydrpolicy.backend.mcp.server - INFO - Received get_policy_from_ID request for policy_id: 7
2025-04-14 02:37:35,260 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:37:35,263 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 02:37:41,465 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:37:41,465 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:37:41,465 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:37:41,465 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:37:41,547 - ydrpolicy.backend.agent - CRITICAL - Failed to start FastAPI server: cannot import name 'ToolCallOutputItem' from 'agents.stream_events' (/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/stream_events.py)
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 418, in agent_command
    uvicorn.run(
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/main.py", line 579, in run
    server.run()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 66, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 70, in serve
    await self._serve(sockets)
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 77, in _serve
    config.load()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/config.py", line 435, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 999, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/api_main.py", line 12, in <module>
    from ydrpolicy.backend.routers import chat as chat_router  # Import the chat router
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/routers/chat.py", line 16, in <module>
    from ydrpolicy.backend.services.chat_service import ChatService
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/services/chat_service.py", line 27, in <module>
    from agents.stream_events import (
ImportError: cannot import name 'ToolCallOutputItem' from 'agents.stream_events' (/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/stream_events.py)
2025-04-14 02:38:04,995 - ydrpolicy.backend.mcp.server - INFO - MCP server process finished.
2025-04-14 02:38:04,996 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 02:38:08,730 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 02:38:08,730 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 02:38:08,731 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 02:38:15,450 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:38:15,450 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:38:15,451 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:38:15,451 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:38:15,532 - ydrpolicy.backend.agent - CRITICAL - Failed to start FastAPI server: cannot import name 'ToolCallOutputItem' from 'agents.stream_events' (/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/stream_events.py)
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 418, in agent_command
    uvicorn.run(
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/main.py", line 579, in run
    server.run()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 66, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 70, in serve
    await self._serve(sockets)
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 77, in _serve
    config.load()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/config.py", line 435, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 999, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/api_main.py", line 12, in <module>
    from ydrpolicy.backend.routers import chat as chat_router  # Import the chat router
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/routers/chat.py", line 16, in <module>
    from ydrpolicy.backend.services.chat_service import ChatService
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/services/chat_service.py", line 27, in <module>
    from agents.stream_events import (
ImportError: cannot import name 'ToolCallOutputItem' from 'agents.stream_events' (/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/agents/stream_events.py)
2025-04-14 02:40:52,673 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:40:52,674 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:40:52,674 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:40:52,674 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:40:52,759 - ydrpolicy.backend.agent - CRITICAL - Failed to start FastAPI server: cannot import name 'Function' from 'openai.types.responses' (/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/openai/types/responses/__init__.py)
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 418, in agent_command
    uvicorn.run(
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/main.py", line 579, in run
    server.run()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 66, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 70, in serve
    await self._serve(sockets)
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 77, in _serve
    config.load()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/config.py", line 435, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 999, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/api_main.py", line 12, in <module>
    from ydrpolicy.backend.routers import chat as chat_router  # Import the chat router
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/routers/chat.py", line 16, in <module>
    from ydrpolicy.backend.services.chat_service import ChatService
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/services/chat_service.py", line 36, in <module>
    from openai.types.responses import Function, ResponseTextDeltaEvent, ToolCall
ImportError: cannot import name 'Function' from 'openai.types.responses' (/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/openai/types/responses/__init__.py)
2025-04-14 02:41:53,395 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:41:53,396 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:41:53,396 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:41:53,396 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:41:53,604 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:41:53,604 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Initiated...
2025-04-14 02:41:53,604 - ydrpolicy.backend.api_main - INFO - Mode: Production
2025-04-14 02:41:53,605 - ydrpolicy.backend.api_main - INFO - CORS Origins Allowed: ['http://localhost:3000']
2025-04-14 02:41:53,605 - ydrpolicy.backend.api_main - INFO - Verified required directories exist.
2025-04-14 02:41:53,605 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Complete.
2025-04-14 02:41:53,605 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:45:57,074 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:45:57,076 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Initiated...
2025-04-14 02:45:57,076 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Complete.
2025-04-14 02:45:57,077 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:47:34,449 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:47:34,449 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:47:34,449 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:47:34,449 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:47:34,645 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:47:34,645 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Initiated...
2025-04-14 02:47:34,646 - ydrpolicy.backend.api_main - INFO - Mode: Production
2025-04-14 02:47:34,646 - ydrpolicy.backend.api_main - INFO - CORS Origins Allowed: ['http://localhost:3000']
2025-04-14 02:47:34,646 - ydrpolicy.backend.api_main - INFO - Verified required directories exist.
2025-04-14 02:47:34,646 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Complete.
2025-04-14 02:47:34,646 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:49:39,526 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 1, chat 0: What is the Yale policy on resident shifts in high volume hours?...
2025-04-14 02:49:39,527 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 1, chat 0, message: 'What is the Yale policy on resident shifts in high volume hours?...'
2025-04-14 02:49:39,528 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 02:49:39,529 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:49:39,529 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:49:39,530 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:49:39,530 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:49:39,531 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:49:39,532 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:49:39,532 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 02:49:39,570 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 02:49:39,570 - ydrpolicy.backend.database.engine - INFO - Creating new database engine
2025-04-14 02:49:39,581 - ydrpolicy.backend.database.engine - INFO - Database engine created successfully
2025-04-14 02:49:39,581 - ydrpolicy.backend.database.repository.chats - INFO - Creating new chat for user ID 1 with title 'What is the Yale policy on resident shifts in high volume hours?'.
2025-04-14 02:49:39,605 - ydrpolicy.backend.database.repository.chats - INFO - SUCCESS: Successfully created chat ID 1 for user ID 1.
2025-04-14 02:49:39,605 - ydrpolicy.backend.services.chat_service - INFO - Created new chat ID 1 for user 1.
2025-04-14 02:49:39,606 - ydrpolicy.backend.database.engine - ERROR - Session rolled back due to error: 1 validation error for StreamChunk
data
  Input should be a valid dictionary or instance of StreamChunkData [type=model_type, input_value=ChatInfoData(chat_id=1, t... in high volume hours?'), input_type=ChatInfoData]
    For further information visit https://errors.pydantic.dev/2.10/v/model_type
2025-04-14 02:49:39,607 - ydrpolicy.backend.services.chat_service - ERROR - Critical error in chat service for user 1, chat 0: 1 validation error for StreamChunk
data
  Input should be a valid dictionary or instance of StreamChunkData [type=model_type, input_value=ChatInfoData(chat_id=1, t... in high volume hours?'), input_type=ChatInfoData]
    For further information visit https://errors.pydantic.dev/2.10/v/model_type
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/services/chat_service.py", line 209, in process_user_message_stream
    yield StreamChunk(type="chat_info", data=ChatInfoData(chat_id=processed_chat_id, title=chat_title))
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/main.py", line 214, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for StreamChunk
data
  Input should be a valid dictionary or instance of StreamChunkData [type=model_type, input_value=ChatInfoData(chat_id=1, t... in high volume hours?'), input_type=ChatInfoData]
    For further information visit https://errors.pydantic.dev/2.10/v/model_type
2025-04-14 02:49:39,631 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'error' for chat 1
2025-04-14 02:49:39,631 - ydrpolicy.backend.routers.chat - ERROR - Error during stream event generation for user 1, chat 0: 1 validation error for StreamChunk
data
  Input should be a valid dictionary or instance of StreamChunkData [type=model_type, input_value=StatusData(status='error', chat_id=1), input_type=StatusData]
    For further information visit https://errors.pydantic.dev/2.10/v/model_type
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/routers/chat.py", line 87, in event_generator
    async for chunk in chat_service.process_user_message_stream(
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/services/chat_service.py", line 395, in process_user_message_stream
    yield StreamChunk(type="status", data=StatusData(status=final_status_str, chat_id=processed_chat_id))
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/main.py", line 214, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for StreamChunk
data
  Input should be a valid dictionary or instance of StreamChunkData [type=model_type, input_value=StatusData(status='error', chat_id=1), input_type=StatusData]
    For further information visit https://errors.pydantic.dev/2.10/v/model_type
2025-04-14 02:54:20,526 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:54:20,528 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Initiated...
2025-04-14 02:54:20,529 - ydrpolicy.backend.agent.mcp_connection - INFO - Closing MCP server connection...
2025-04-14 02:54:20,530 - ydrpolicy.backend.agent.mcp_connection - INFO - MCP server connection closed.
2025-04-14 02:54:20,531 - ydrpolicy.backend.database.engine - INFO - Closing database connection pool
2025-04-14 02:54:20,537 - ydrpolicy.backend.database.engine - INFO - Database connection pool closed
2025-04-14 02:54:20,538 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Complete.
2025-04-14 02:54:20,538 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:54:24,343 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:54:24,343 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 02:54:24,343 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:54:24,344 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 02:54:24,549 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:54:24,549 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Initiated...
2025-04-14 02:54:24,550 - ydrpolicy.backend.api_main - INFO - Mode: Production
2025-04-14 02:54:24,550 - ydrpolicy.backend.api_main - INFO - CORS Origins Allowed: ['http://localhost:3000']
2025-04-14 02:54:24,550 - ydrpolicy.backend.api_main - INFO - Verified required directories exist.
2025-04-14 02:54:24,550 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Complete.
2025-04-14 02:54:24,551 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:54:38,367 - ydrpolicy.backend.services.chat_service - INFO - ChatService initialized (MCP Enabled: True)
2025-04-14 02:54:38,373 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 1, chat 0: What is the Yale policy on resident shifts in high volume hours?...
2025-04-14 02:54:38,375 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 1, chat 0, message: 'What is the Yale policy on resident shifts in high volume hours?...'
2025-04-14 02:54:38,376 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 02:54:38,376 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:54:38,377 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:54:38,378 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:54:38,378 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:54:38,378 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:54:38,379 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:54:38,379 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 02:54:38,414 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 02:54:38,414 - ydrpolicy.backend.database.engine - INFO - Creating new database engine
2025-04-14 02:54:38,425 - ydrpolicy.backend.database.engine - INFO - Database engine created successfully
2025-04-14 02:54:38,425 - ydrpolicy.backend.database.repository.chats - INFO - Creating new chat for user ID 1 with title 'What is the Yale policy on resident shifts in high volume hours?'.
2025-04-14 02:54:38,447 - ydrpolicy.backend.database.repository.chats - INFO - SUCCESS: Successfully created chat ID 2 for user ID 1.
2025-04-14 02:54:38,448 - ydrpolicy.backend.services.chat_service - INFO - Created new chat ID 2 for user 1.
2025-04-14 02:54:38,465 - ydrpolicy.backend.services.chat_service - INFO - Agent updated to: YDR Policy Assistant in chat 2
2025-04-14 02:54:41,077 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='Yale policy on resident shifts in high volume hour...', k=5, threshold=None
2025-04-14 02:54:41,741 - ydrpolicy.backend.database.engine - INFO - Creating new database engine
2025-04-14 02:54:41,762 - ydrpolicy.backend.database.engine - INFO - Database engine created successfully
2025-04-14 02:54:41,763 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 02:54:41,804 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 02:54:41,821 - ydrpolicy.backend.services.chat_service - INFO - Agent calling tool: find_similar_chunks in chat 2
2025-04-14 02:54:41,822 - ydrpolicy.backend.services.chat_service - WARNING - ToolCallOutputItem missing tool_call_id for chat 2
2025-04-14 02:54:41,834 - ydrpolicy.backend.services.chat_service - INFO - Tool output received for chat 2
2025-04-14 02:54:45,224 - ydrpolicy.backend.mcp.server - INFO - Received get_policy_from_ID request for policy_id: 2
2025-04-14 02:54:45,267 - ydrpolicy.backend.services.chat_service - INFO - Agent calling tool: get_policy_from_ID in chat 2
2025-04-14 02:54:45,267 - ydrpolicy.backend.services.chat_service - WARNING - ToolCallOutputItem missing tool_call_id for chat 2
2025-04-14 02:54:45,279 - ydrpolicy.backend.services.chat_service - INFO - Tool output received for chat 2
2025-04-14 02:54:51,258 - ydrpolicy.backend.services.chat_service - INFO - Agent stream completed successfully for chat 2.
2025-04-14 02:54:51,263 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'complete' for chat 2
2025-04-14 02:54:51,274 - ydrpolicy.backend.routers.chat - INFO - API: Finished streaming response for user 1, chat new.
2025-04-14 02:56:19,947 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:56:19,949 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Initiated...
2025-04-14 02:56:19,950 - ydrpolicy.backend.agent.mcp_connection - INFO - Closing MCP server connection...
2025-04-14 02:56:19,951 - ydrpolicy.backend.agent.mcp_connection - INFO - MCP server connection closed.
2025-04-14 02:56:19,951 - ydrpolicy.backend.database.engine - INFO - Closing database connection pool
2025-04-14 02:56:19,956 - ydrpolicy.backend.database.engine - INFO - Database connection pool closed
2025-04-14 02:56:19,957 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Complete.
2025-04-14 02:56:19,958 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 02:56:29,384 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 02:56:29,385 - ydrpolicy.backend.agent - INFO - Agent requested mode: Terminal
2025-04-14 02:56:29,385 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 02:56:29,385 - ydrpolicy.backend.agent - INFO - Starting agent in terminal mode (using session history, not persistent)...
2025-04-14 02:56:29,386 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 02:56:29,386 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 02:56:29,386 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 02:56:29,387 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 02:56:29,387 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 02:56:29,387 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 02:56:29,407 - ydrpolicy.backend.agent.terminal - INFO - Terminal Mode: MCP connection established via async context.
2025-04-14 02:56:32,272 - ydrpolicy.backend.agent.terminal - INFO - Terminal chat session ended.
2025-04-14 02:56:32,275 - ydrpolicy.backend.agent - INFO - Terminal agent process finished.
2025-04-14 03:09:41,115 - ydrpolicy.backend.mcp.server - INFO - MCP server process finished.
2025-04-14 03:09:41,116 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 13:08:25,494 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 13:08:25,495 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 13:08:25,495 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 13:08:32,520 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 13:08:32,521 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 13:08:32,521 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 13:08:44,262 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 13:08:44,262 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 13:08:44,262 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 13:10:14,333 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 13:10:14,333 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 13:10:14,334 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 13:11:33,058 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 13:11:33,059 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 13:11:33,059 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 13:11:39,678 - ydrpolicy.backend.mcp.server - INFO - MCP server process finished.
2025-04-14 13:11:39,680 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 13:11:46,105 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 13:11:46,106 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 13:11:46,106 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 13:11:55,319 - ydrpolicy.backend.mcp.server - INFO - MCP server process finished.
2025-04-14 13:11:55,322 - ydrpolicy.backend.mcp - INFO - MCP server process finished.
2025-04-14 13:12:02,788 - ydrpolicy.backend.mcp - INFO - Attempting to start MCP server on 0.0.0.0:8001 via http transport...
2025-04-14 13:12:02,789 - ydrpolicy.backend.mcp.server - INFO - Attempting to start MCP server using http transport...
2025-04-14 13:12:02,789 - ydrpolicy.backend.mcp.server - INFO - Running MCP server with http/sse transport via uvicorn on 0.0.0.0:8001.
2025-04-14 13:12:17,576 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 13:12:17,576 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 13:12:17,576 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 13:12:17,576 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 13:12:17,776 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:12:17,776 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Initiated...
2025-04-14 13:12:17,777 - ydrpolicy.backend.api_main - INFO - Mode: Production
2025-04-14 13:12:17,777 - ydrpolicy.backend.api_main - INFO - CORS Origins Allowed: ['http://localhost:3000']
2025-04-14 13:12:17,777 - ydrpolicy.backend.api_main - INFO - Verified required directories exist.
2025-04-14 13:12:17,777 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Complete.
2025-04-14 13:12:17,778 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:12:41,706 - ydrpolicy.backend.services.chat_service - INFO - ChatService initialized (MCP Enabled: True)
2025-04-14 13:12:41,711 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 0, chat 0: Hi. This is Pouria. Nice to meet you!...
2025-04-14 13:12:41,713 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 0, chat 0, message: 'Hi. This is Pouria. Nice to meet you!...'
2025-04-14 13:12:41,714 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 13:12:41,714 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 13:12:41,715 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 13:12:41,715 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 13:12:41,716 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 13:12:41,717 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 13:12:41,718 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 13:12:41,719 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 13:12:41,768 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 13:12:41,769 - ydrpolicy.backend.database.engine - INFO - Creating new database engine
2025-04-14 13:12:41,791 - ydrpolicy.backend.database.engine - INFO - Database engine created successfully
2025-04-14 13:12:41,791 - ydrpolicy.backend.database.repository.chats - INFO - Creating new chat for user ID 0 with title 'Hi. This is Pouria. Nice to meet you!'.
2025-04-14 13:12:41,813 - ydrpolicy.backend.database.repository.chats - ERROR - Cannot create chat: User with ID 0 not found.
2025-04-14 13:12:41,814 - ydrpolicy.backend.database.engine - ERROR - Session rolled back due to error: User with ID 0 not found.
2025-04-14 13:12:41,815 - ydrpolicy.backend.services.chat_service - ERROR - Critical error in chat service for user 0, chat 0: User with ID 0 not found.
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/services/chat_service.py", line 228, in process_user_message_stream
    new_chat = await chat_repo.create_chat(user_id=user_id, title=new_title)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/database/repository/chats.py", line 99, in create_chat
    raise ValueError(f"User with ID {user_id} not found.")
ValueError: User with ID 0 not found.
2025-04-14 13:12:41,849 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'error' for chat 0
2025-04-14 13:12:41,860 - ydrpolicy.backend.routers.chat - INFO - API: Finished streaming response for user 0, chat new.
2025-04-14 13:13:00,387 - ydrpolicy.backend.services.chat_service - INFO - ChatService initialized (MCP Enabled: True)
2025-04-14 13:13:00,388 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 1, chat 0: Hi. This is Pouria. Nice to meet you!...
2025-04-14 13:13:00,390 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 1, chat 0, message: 'Hi. This is Pouria. Nice to meet you!...'
2025-04-14 13:13:00,390 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 13:13:00,391 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 13:13:00,392 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 13:13:00,392 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 13:13:00,393 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 13:13:00,436 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 13:13:00,437 - ydrpolicy.backend.database.repository.chats - INFO - Creating new chat for user ID 1 with title 'Hi. This is Pouria. Nice to meet you!'.
2025-04-14 13:13:00,445 - ydrpolicy.backend.database.repository.chats - INFO - SUCCESS: Successfully created chat ID 3 for user ID 1.
2025-04-14 13:13:00,446 - ydrpolicy.backend.services.chat_service - INFO - Created new chat ID 3 for user 1.
2025-04-14 13:13:00,462 - ydrpolicy.backend.services.chat_service - INFO - Agent updated to: YDR Policy Assistant in chat 3
2025-04-14 13:13:04,282 - ydrpolicy.backend.services.chat_service - INFO - Agent stream completed successfully for chat 3.
2025-04-14 13:13:04,292 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'complete' for chat 3
2025-04-14 13:13:04,305 - ydrpolicy.backend.routers.chat - INFO - API: Finished streaming response for user 1, chat new.
2025-04-14 13:13:34,223 - ydrpolicy.backend.services.chat_service - INFO - ChatService initialized (MCP Enabled: True)
2025-04-14 13:13:34,224 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 1, chat 1: Hi. Who are you?!...
2025-04-14 13:13:34,228 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 1, chat 1, message: 'Hi. Who are you?!...'
2025-04-14 13:13:34,229 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 13:13:34,230 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 13:13:34,230 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 13:13:34,231 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 13:13:34,232 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 13:13:34,324 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 13:13:34,328 - ydrpolicy.backend.database.repository.chats - WARNING - Chat ID 1 not found or does not belong to user ID 1.
2025-04-14 13:13:34,329 - ydrpolicy.backend.services.chat_service - ERROR - Chat ID 1 not found or does not belong to user ID 1.
2025-04-14 13:13:34,342 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'error' for chat 1
2025-04-14 13:13:34,353 - ydrpolicy.backend.routers.chat - INFO - API: Finished streaming response for user 1, chat 1.
2025-04-14 13:13:51,043 - ydrpolicy.backend.services.chat_service - INFO - ChatService initialized (MCP Enabled: True)
2025-04-14 13:13:51,043 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 1, chat 0: Hi. Who are you?!...
2025-04-14 13:13:51,045 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 1, chat 0, message: 'Hi. Who are you?!...'
2025-04-14 13:13:51,046 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 13:13:51,046 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 13:13:51,047 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 13:13:51,047 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 13:13:51,048 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 13:13:51,088 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 13:13:51,089 - ydrpolicy.backend.database.repository.chats - INFO - Creating new chat for user ID 1 with title 'Hi. Who are you?!'.
2025-04-14 13:13:51,092 - ydrpolicy.backend.database.repository.chats - INFO - SUCCESS: Successfully created chat ID 4 for user ID 1.
2025-04-14 13:13:51,093 - ydrpolicy.backend.services.chat_service - INFO - Created new chat ID 4 for user 1.
2025-04-14 13:13:51,106 - ydrpolicy.backend.services.chat_service - INFO - Agent updated to: YDR Policy Assistant in chat 4
2025-04-14 13:13:55,278 - ydrpolicy.backend.services.chat_service - INFO - Agent stream completed successfully for chat 4.
2025-04-14 13:13:55,286 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'complete' for chat 4
2025-04-14 13:13:55,298 - ydrpolicy.backend.routers.chat - INFO - API: Finished streaming response for user 1, chat new.
2025-04-14 13:14:42,744 - ydrpolicy.backend.services.chat_service - INFO - ChatService initialized (MCP Enabled: True)
2025-04-14 13:14:42,745 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 1, chat 4: What tools do you have access to?!...
2025-04-14 13:14:42,746 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 1, chat 4, message: 'What tools do you have access to?!...'
2025-04-14 13:14:42,747 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 13:14:42,748 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 13:14:42,749 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 13:14:42,749 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 13:14:42,750 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 13:14:42,790 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 13:14:42,812 - ydrpolicy.backend.services.chat_service - INFO - Agent updated to: YDR Policy Assistant in chat 4
2025-04-14 13:14:46,581 - ydrpolicy.backend.services.chat_service - INFO - Agent stream completed successfully for chat 4.
2025-04-14 13:14:46,589 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'complete' for chat 4
2025-04-14 13:14:46,602 - ydrpolicy.backend.routers.chat - INFO - API: Finished streaming response for user 1, chat 4.
2025-04-14 13:16:14,962 - ydrpolicy.backend.services.chat_service - INFO - ChatService initialized (MCP Enabled: True)
2025-04-14 13:16:14,963 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 1, chat 4: Can you search the policies to see how the residents schedule change during high volume hours?!...
2025-04-14 13:16:14,967 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 1, chat 4, message: 'Can you search the policies to see how the residents schedule change during high volume hours?!...'
2025-04-14 13:16:14,968 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 13:16:14,969 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 13:16:14,970 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 13:16:14,970 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 13:16:14,971 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 13:16:15,009 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 13:16:15,026 - ydrpolicy.backend.services.chat_service - INFO - Agent updated to: YDR Policy Assistant in chat 4
2025-04-14 13:16:18,920 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='residents schedule change during high volume hours...', k=5, threshold=None
2025-04-14 13:16:19,666 - ydrpolicy.backend.database.engine - INFO - Creating new database engine
2025-04-14 13:16:19,693 - ydrpolicy.backend.database.engine - INFO - Database engine created successfully
2025-04-14 13:16:19,694 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 13:16:19,743 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 13:16:19,765 - ydrpolicy.backend.services.chat_service - INFO - Agent calling tool: find_similar_chunks in chat 4
2025-04-14 13:16:19,765 - ydrpolicy.backend.services.chat_service - WARNING - ToolCallOutputItem missing tool_call_id for chat 4
2025-04-14 13:16:19,777 - ydrpolicy.backend.services.chat_service - INFO - Tool output received for chat 4
2025-04-14 13:16:24,892 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='resident scheduling change during high volume hour...', k=5, threshold=None
2025-04-14 13:16:26,034 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 13:16:26,046 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 13:16:26,064 - ydrpolicy.backend.services.chat_service - INFO - Agent calling tool: find_similar_chunks in chat 4
2025-04-14 13:16:26,064 - ydrpolicy.backend.services.chat_service - WARNING - ToolCallOutputItem missing tool_call_id for chat 4
2025-04-14 13:16:26,075 - ydrpolicy.backend.services.chat_service - INFO - Tool output received for chat 4
2025-04-14 13:16:42,612 - ydrpolicy.backend.services.chat_service - INFO - Agent stream completed successfully for chat 4.
2025-04-14 13:16:42,619 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'complete' for chat 4
2025-04-14 13:16:42,633 - ydrpolicy.backend.routers.chat - INFO - API: Finished streaming response for user 1, chat 4.
2025-04-14 13:19:09,953 - ydrpolicy.backend.routers.chat - WARNING - Using placeholder user ID 1 for authentication.
2025-04-14 13:19:09,955 - ydrpolicy.backend.routers.chat - INFO - API: Received request to list chats for user 1 (skip=0, limit=100).
2025-04-14 13:19:09,957 - ydrpolicy.backend.routers.chat - ERROR - Error fetching chats for user 1: '_AsyncGeneratorContextManager' object has no attribute 'execute'
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/routers/chat.py", line 147, in list_user_chats
    chats = await chat_repo.get_chats_by_user(user_id=user_id, skip=skip, limit=limit)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/database/repository/chats.py", line 75, in get_chats_by_user
    result = await self.session.execute(stmt)
                   ^^^^^^^^^^^^^^^^^^^^
AttributeError: '_AsyncGeneratorContextManager' object has no attribute 'execute'
2025-04-14 13:20:56,174 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:20:56,176 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Initiated...
2025-04-14 13:20:56,177 - ydrpolicy.backend.agent.mcp_connection - INFO - Closing MCP server connection...
2025-04-14 13:20:56,178 - ydrpolicy.backend.agent.mcp_connection - INFO - MCP server connection closed.
2025-04-14 13:20:56,179 - ydrpolicy.backend.database.engine - INFO - Closing database connection pool
2025-04-14 13:20:56,186 - ydrpolicy.backend.database.engine - INFO - Database connection pool closed
2025-04-14 13:20:56,188 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Complete.
2025-04-14 13:20:56,189 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:20:59,520 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 13:20:59,520 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 13:20:59,520 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 13:20:59,520 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 13:20:59,765 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:20:59,765 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Initiated...
2025-04-14 13:20:59,765 - ydrpolicy.backend.api_main - INFO - Mode: Production
2025-04-14 13:20:59,766 - ydrpolicy.backend.api_main - INFO - CORS Origins Allowed: ['http://localhost:3000']
2025-04-14 13:20:59,766 - ydrpolicy.backend.api_main - INFO - Verified required directories exist.
2025-04-14 13:20:59,766 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Complete.
2025-04-14 13:20:59,766 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:21:10,651 - ydrpolicy.backend.routers.chat - WARNING - Using placeholder user ID 1 for authentication.
2025-04-14 13:21:10,658 - ydrpolicy.backend.routers.chat - INFO - API: Received request to list chats for user 1 (skip=0, limit=100).
2025-04-14 13:21:10,660 - ydrpolicy.backend.routers.chat - ERROR - Error fetching chats for user 1: '_AsyncGeneratorContextManager' object has no attribute 'execute'
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/routers/chat.py", line 135, in list_user_chats
    chats = await chat_repo.get_chats_by_user(user_id=user_id, skip=skip, limit=limit)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/database/repository/chats.py", line 75, in get_chats_by_user
    result = await self.session.execute(stmt)
                   ^^^^^^^^^^^^^^^^^^^^
AttributeError: '_AsyncGeneratorContextManager' object has no attribute 'execute'
2025-04-14 13:21:44,643 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:21:44,646 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Initiated...
2025-04-14 13:21:44,649 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Complete.
2025-04-14 13:21:44,651 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:21:47,434 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 13:21:47,435 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 13:21:47,435 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 13:21:47,435 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 13:21:47,656 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:21:47,656 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Initiated...
2025-04-14 13:21:47,656 - ydrpolicy.backend.api_main - INFO - Mode: Production
2025-04-14 13:21:47,656 - ydrpolicy.backend.api_main - INFO - CORS Origins Allowed: ['http://localhost:3000']
2025-04-14 13:21:47,657 - ydrpolicy.backend.api_main - INFO - Verified required directories exist.
2025-04-14 13:21:47,657 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Complete.
2025-04-14 13:21:47,657 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:21:52,669 - ydrpolicy.backend.routers.chat - WARNING - Using placeholder user ID 1 for authentication.
2025-04-14 13:21:52,677 - ydrpolicy.backend.routers.chat - INFO - API: Received request to list chats for user 1 (skip=0, limit=100).
2025-04-14 13:21:52,679 - ydrpolicy.backend.routers.chat - ERROR - Error fetching chats for user 1: '_AsyncGeneratorContextManager' object has no attribute 'execute'
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/routers/chat.py", line 135, in list_user_chats
    chats = await chat_repo.get_chats_by_user(user_id=user_id, skip=skip, limit=limit)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/database/repository/chats.py", line 75, in get_chats_by_user
    result = await self.session.execute(stmt)
                   ^^^^^^^^^^^^^^^^^^^^
AttributeError: '_AsyncGeneratorContextManager' object has no attribute 'execute'
2025-04-14 13:23:41,118 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:23:41,121 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Initiated...
2025-04-14 13:23:41,122 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Complete.
2025-04-14 13:23:41,122 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:23:43,269 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 13:23:43,269 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 13:23:43,270 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 13:23:43,270 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 13:23:43,511 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:23:43,511 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Initiated...
2025-04-14 13:23:43,512 - ydrpolicy.backend.api_main - INFO - Mode: Production
2025-04-14 13:23:43,512 - ydrpolicy.backend.api_main - INFO - CORS Origins Allowed: ['http://localhost:3000']
2025-04-14 13:23:43,512 - ydrpolicy.backend.api_main - INFO - Verified required directories exist.
2025-04-14 13:23:43,512 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Complete.
2025-04-14 13:23:43,512 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:23:48,354 - ydrpolicy.backend.routers.chat - WARNING - Using placeholder user ID 1 for authentication.
2025-04-14 13:23:48,356 - ydrpolicy.backend.database.engine - INFO - Creating new database engine
2025-04-14 13:23:48,383 - ydrpolicy.backend.database.engine - INFO - Database engine created successfully
2025-04-14 13:23:48,384 - ydrpolicy.backend.routers.chat - INFO - API: Received request to list chats for user 1 (skip=0, limit=100).
2025-04-14 13:24:32,103 - ydrpolicy.backend.routers.chat - WARNING - Using placeholder user ID 1 for authentication.
2025-04-14 13:24:32,104 - ydrpolicy.backend.routers.chat - INFO - API: Received request for messages in chat 2 for user 1 (skip=0, limit=100).
2025-04-14 13:25:26,010 - ydrpolicy.backend.routers.chat - WARNING - Using placeholder user ID 1 for authentication.
2025-04-14 13:25:26,011 - ydrpolicy.backend.routers.chat - INFO - API: Received request to list chats for user 1 (skip=0, limit=100).
2025-04-14 13:25:58,345 - ydrpolicy.backend.services.chat_service - INFO - ChatService initialized (MCP Enabled: True)
2025-04-14 13:25:58,351 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 1, chat 0: Who are you...
2025-04-14 13:25:58,353 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 1, chat 0, message: 'Who are you...'
2025-04-14 13:25:58,354 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 13:25:58,354 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 13:25:58,355 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 13:25:58,355 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 13:25:58,356 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 13:25:58,357 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 13:25:58,357 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 13:25:58,358 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 13:25:58,394 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 13:25:58,394 - ydrpolicy.backend.database.repository.chats - INFO - Creating new chat for user ID 1 with title 'Who are you'.
2025-04-14 13:25:58,402 - ydrpolicy.backend.database.repository.chats - INFO - SUCCESS: Successfully created chat ID 5 for user ID 1.
2025-04-14 13:25:58,402 - ydrpolicy.backend.services.chat_service - INFO - Created new chat ID 5 for user 1.
2025-04-14 13:25:58,417 - ydrpolicy.backend.services.chat_service - INFO - Agent updated to: YDR Policy Assistant in chat 5
2025-04-14 13:26:04,884 - ydrpolicy.backend.services.chat_service - INFO - Agent stream completed successfully for chat 5.
2025-04-14 13:26:04,894 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'complete' for chat 5
2025-04-14 13:26:04,906 - ydrpolicy.backend.routers.chat - INFO - API: Finished streaming response for user 1, chat new.
2025-04-14 13:26:51,728 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 13:26:51,729 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Initiated...
2025-04-14 13:26:51,730 - ydrpolicy.backend.agent.mcp_connection - INFO - Closing MCP server connection...
2025-04-14 13:26:51,731 - ydrpolicy.backend.agent.mcp_connection - INFO - MCP server connection closed.
2025-04-14 13:26:51,731 - ydrpolicy.backend.database.engine - INFO - Closing database connection pool
2025-04-14 13:26:51,736 - ydrpolicy.backend.database.engine - INFO - Database connection pool closed
2025-04-14 13:26:51,737 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Complete.
2025-04-14 13:26:51,738 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 14:03:52,365 - ydrpolicy.backend.database - INFO - Executing database command...
2025-04-14 14:03:52,365 - ydrpolicy.backend.database - WARNING - Database drop requested for URL: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy
2025-04-14 14:03:52,366 - ydrpolicy.backend.database.init_db - WARNING - Attempting to drop database 'ydrpolicy'... THIS WILL DELETE ALL DATA!
2025-04-14 14:03:53,626 - ydrpolicy.backend.database.init_db - INFO - Terminating active connections to 'ydrpolicy'...
2025-04-14 14:03:53,631 - ydrpolicy.backend.database.init_db - INFO - Connections terminated.
2025-04-14 14:03:54,133 - ydrpolicy.backend.database.init_db - INFO - Dropping database 'ydrpolicy'...
2025-04-14 14:03:54,187 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Database 'ydrpolicy' dropped successfully.
2025-04-14 14:03:54,193 - ydrpolicy.backend.database - INFO - Database command finished.
2025-04-14 14:03:59,620 - ydrpolicy.backend.database - INFO - Executing database command...
2025-04-14 14:03:59,621 - ydrpolicy.backend.database - INFO - Database initialization (no population) requested for URL: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy
2025-04-14 14:03:59,621 - ydrpolicy.backend.database.init_db - INFO - Starting database initialization for: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy (Populate: False)
2025-04-14 14:03:59,621 - ydrpolicy.backend.database.init_db - INFO - Checking if database 'ydrpolicy' exists...
2025-04-14 14:03:59,630 - ydrpolicy.backend.database.init_db - INFO - Creating database 'ydrpolicy'...
2025-04-14 14:03:59,703 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Database 'ydrpolicy' created.
2025-04-14 14:10:16,216 - ydrpolicy.backend.database - INFO - Executing database command...
2025-04-14 14:10:16,217 - ydrpolicy.backend.database - INFO - Database initialization (no population) requested for URL: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy
2025-04-14 14:10:16,217 - ydrpolicy.backend.database.init_db - INFO - Starting database initialization for: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy (Populate: False)
2025-04-14 14:10:16,218 - ydrpolicy.backend.database.init_db - INFO - Checking if database 'ydrpolicy' exists...
2025-04-14 14:10:16,226 - ydrpolicy.backend.database.init_db - INFO - Database 'ydrpolicy' already exists.
2025-04-14 14:10:16,229 - ydrpolicy.backend.database.init_db - INFO - Ensuring extension 'vector' exists...
2025-04-14 14:10:16,267 - ydrpolicy.backend.database.init_db - INFO - Extension 'vector' checked/created.
2025-04-14 14:10:16,267 - ydrpolicy.backend.database.init_db - INFO - Creating tables, seeding users, and potentially populating policies...
2025-04-14 14:10:16,268 - ydrpolicy.backend.database.init_db - INFO - Creating database tables if they don't exist...
2025-04-14 14:10:16,268 - ydrpolicy.backend.database.init_db - ERROR - Database initialization failed during session operations: 'Session' object has no attribute '_run_ddl_visitor'
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/database/init_db.py", line 375, in init_db
    await session.run_sync(Base.metadata.create_all)
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 398, in run_sync
    return await greenlet_spawn(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 190, in greenlet_spawn
    result = context.switch(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/sqlalchemy/sql/schema.py", line 5907, in create_all
    bind._run_ddl_visitor(
    ^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'Session' object has no attribute '_run_ddl_visitor'
2025-04-14 14:10:16,432 - ydrpolicy.backend.database.init_db - INFO - Database engine disposed.
2025-04-14 14:10:16,433 - ydrpolicy.backend.database - INFO - Database command finished.
2025-04-14 14:12:01,701 - ydrpolicy.backend.database - INFO - Executing database command...
2025-04-14 14:12:01,702 - ydrpolicy.backend.database - INFO - Database initialization (no population) requested for URL: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy
2025-04-14 14:12:01,702 - ydrpolicy.backend.database.init_db - INFO - Starting database initialization for: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy (Populate: False)
2025-04-14 14:12:01,702 - ydrpolicy.backend.database.init_db - INFO - Checking if database 'ydrpolicy' exists...
2025-04-14 14:12:01,710 - ydrpolicy.backend.database.init_db - INFO - Database 'ydrpolicy' already exists.
2025-04-14 14:12:01,714 - ydrpolicy.backend.database.init_db - INFO - Ensuring extension 'vector' exists...
2025-04-14 14:12:01,723 - ydrpolicy.backend.database.init_db - INFO - Extension 'vector' checked/created.
2025-04-14 14:12:01,724 - ydrpolicy.backend.database.init_db - INFO - Creating database tables if they don't exist...
2025-04-14 14:12:01,783 - ydrpolicy.backend.database.init_db - INFO - Tables checked/created.
2025-04-14 14:12:01,783 - ydrpolicy.backend.database.init_db - INFO - Applying search vector triggers...
2025-04-14 14:12:01,800 - ydrpolicy.backend.database.init_db - INFO - Search vector triggers applied.
2025-04-14 14:12:01,800 - ydrpolicy.backend.database.init_db - INFO - Seeding users and potentially populating policies...
2025-04-14 14:12:01,800 - ydrpolicy.backend.database.init_db - INFO - Attempting to seed users from: /Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/auth/users.json
2025-04-14 14:12:01,809 - ydrpolicy.backend.database.init_db - ERROR - Error preparing user 'admin@example.com' for creation: bcrypt: no backends available -- recommend you install one (e.g. 'pip install bcrypt')
2025-04-14 14:12:01,811 - ydrpolicy.backend.database.init_db - ERROR - Error preparing user 'testuser1@example.com' for creation: bcrypt: no backends available -- recommend you install one (e.g. 'pip install bcrypt')
2025-04-14 14:12:01,812 - ydrpolicy.backend.database.init_db - ERROR - Error preparing user 'testuser2@example.com' for creation: bcrypt: no backends available -- recommend you install one (e.g. 'pip install bcrypt')
2025-04-14 14:12:01,813 - ydrpolicy.backend.database.init_db - ERROR - Error preparing user 'testuser3@example.com' for creation: bcrypt: no backends available -- recommend you install one (e.g. 'pip install bcrypt')
2025-04-14 14:12:01,813 - ydrpolicy.backend.database.init_db - INFO - User seeding complete. Prepared: 0, Skipped: 0
2025-04-14 14:12:01,813 - ydrpolicy.backend.database.init_db - INFO - Skipping policy data population step.
2025-04-14 14:12:01,814 - ydrpolicy.backend.database.init_db - INFO - User seeding and policy population committed.
2025-04-14 14:12:01,814 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Database initialization completed successfully.
2025-04-14 14:12:01,821 - ydrpolicy.backend.database.init_db - INFO - Database engine disposed.
2025-04-14 14:12:01,822 - ydrpolicy.backend.database - INFO - Database command finished.
2025-04-14 14:12:24,283 - ydrpolicy.backend.database - INFO - Executing database command...
2025-04-14 14:12:24,283 - ydrpolicy.backend.database - INFO - Database initialization (no population) requested for URL: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy
2025-04-14 14:12:24,284 - ydrpolicy.backend.database.init_db - INFO - Starting database initialization for: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy (Populate: False)
2025-04-14 14:12:24,284 - ydrpolicy.backend.database.init_db - INFO - Checking if database 'ydrpolicy' exists...
2025-04-14 14:12:24,290 - ydrpolicy.backend.database.init_db - INFO - Database 'ydrpolicy' already exists.
2025-04-14 14:12:24,293 - ydrpolicy.backend.database.init_db - INFO - Ensuring extension 'vector' exists...
2025-04-14 14:12:24,302 - ydrpolicy.backend.database.init_db - INFO - Extension 'vector' checked/created.
2025-04-14 14:12:24,302 - ydrpolicy.backend.database.init_db - INFO - Creating database tables if they don't exist...
2025-04-14 14:12:24,308 - ydrpolicy.backend.database.init_db - INFO - Tables checked/created.
2025-04-14 14:12:24,309 - ydrpolicy.backend.database.init_db - INFO - Applying search vector triggers...
2025-04-14 14:12:24,315 - ydrpolicy.backend.database.init_db - INFO - Search vector triggers applied.
2025-04-14 14:12:24,315 - ydrpolicy.backend.database.init_db - INFO - Seeding users and potentially populating policies...
2025-04-14 14:12:24,315 - ydrpolicy.backend.database.init_db - INFO - Attempting to seed users from: /Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/auth/users.json
2025-04-14 14:12:24,800 - ydrpolicy.backend.database.init_db - INFO - Prepared new user for creation: admin@example.com (Admin: True)
2025-04-14 14:12:24,994 - ydrpolicy.backend.database.init_db - INFO - Prepared new user for creation: testuser1@example.com (Admin: False)
2025-04-14 14:12:25,182 - ydrpolicy.backend.database.init_db - INFO - Prepared new user for creation: testuser2@example.com (Admin: False)
2025-04-14 14:12:25,370 - ydrpolicy.backend.database.init_db - INFO - Prepared new user for creation: testuser3@example.com (Admin: False)
2025-04-14 14:12:25,370 - ydrpolicy.backend.database.init_db - INFO - User seeding complete. Prepared: 4, Skipped: 0
2025-04-14 14:12:25,370 - ydrpolicy.backend.database.init_db - INFO - Skipping policy data population step.
2025-04-14 14:12:25,371 - ydrpolicy.backend.database.init_db - INFO - User seeding and policy population committed.
2025-04-14 14:12:25,372 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Database initialization completed successfully.
2025-04-14 14:12:25,375 - ydrpolicy.backend.database.init_db - INFO - Database engine disposed.
2025-04-14 14:12:25,376 - ydrpolicy.backend.database - INFO - Database command finished.
2025-04-14 14:13:29,883 - ydrpolicy.backend.database - INFO - Executing database command...
2025-04-14 14:13:29,883 - ydrpolicy.backend.database - WARNING - Database drop requested for URL: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy
2025-04-14 14:13:29,883 - ydrpolicy.backend.database.init_db - WARNING - Attempting to drop database 'ydrpolicy'... THIS WILL DELETE ALL DATA!
2025-04-14 14:13:30,502 - ydrpolicy.backend.database.init_db - INFO - Terminating active connections to 'ydrpolicy'...
2025-04-14 14:13:30,507 - ydrpolicy.backend.database.init_db - INFO - Connections terminated.
2025-04-14 14:13:31,010 - ydrpolicy.backend.database.init_db - INFO - Dropping database 'ydrpolicy'...
2025-04-14 14:13:31,048 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Database 'ydrpolicy' dropped successfully.
2025-04-14 14:13:31,053 - ydrpolicy.backend.database - INFO - Database command finished.
2025-04-14 14:13:35,731 - ydrpolicy.backend.database - INFO - Executing database command...
2025-04-14 14:13:35,732 - ydrpolicy.backend.database - INFO - Database initialization (no population) requested for URL: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy
2025-04-14 14:13:35,732 - ydrpolicy.backend.database.init_db - INFO - Starting database initialization for: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy (Populate: False)
2025-04-14 14:13:35,733 - ydrpolicy.backend.database.init_db - INFO - Checking if database 'ydrpolicy' exists...
2025-04-14 14:13:35,741 - ydrpolicy.backend.database.init_db - INFO - Creating database 'ydrpolicy'...
2025-04-14 14:13:35,801 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Database 'ydrpolicy' created.
2025-04-14 14:13:35,803 - ydrpolicy.backend.database.init_db - INFO - Ensuring extension 'vector' exists...
2025-04-14 14:13:35,821 - ydrpolicy.backend.database.init_db - INFO - Extension 'vector' checked/created.
2025-04-14 14:13:35,821 - ydrpolicy.backend.database.init_db - INFO - Creating database tables if they don't exist...
2025-04-14 14:13:35,851 - ydrpolicy.backend.database.init_db - INFO - Tables checked/created.
2025-04-14 14:13:35,851 - ydrpolicy.backend.database.init_db - INFO - Applying search vector triggers...
2025-04-14 14:13:35,855 - ydrpolicy.backend.database.init_db - INFO - Search vector triggers applied.
2025-04-14 14:13:35,855 - ydrpolicy.backend.database.init_db - INFO - Seeding users and potentially populating policies...
2025-04-14 14:13:35,855 - ydrpolicy.backend.database.init_db - INFO - Attempting to seed users from: /Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/auth/users.json
2025-04-14 14:13:36,075 - ydrpolicy.backend.database.init_db - INFO - Prepared new user for creation: admin@example.com (Admin: True)
2025-04-14 14:13:36,246 - ydrpolicy.backend.database.init_db - INFO - Prepared new user for creation: testuser1@example.com (Admin: False)
2025-04-14 14:13:36,415 - ydrpolicy.backend.database.init_db - INFO - Prepared new user for creation: testuser2@example.com (Admin: False)
2025-04-14 14:13:36,583 - ydrpolicy.backend.database.init_db - INFO - Prepared new user for creation: testuser3@example.com (Admin: False)
2025-04-14 14:13:36,584 - ydrpolicy.backend.database.init_db - INFO - User seeding complete. Prepared: 4, Skipped: 0
2025-04-14 14:13:36,584 - ydrpolicy.backend.database.init_db - INFO - Skipping policy data population step.
2025-04-14 14:13:36,586 - ydrpolicy.backend.database.init_db - INFO - User seeding and policy population committed.
2025-04-14 14:13:36,586 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Database initialization completed successfully.
2025-04-14 14:13:36,599 - ydrpolicy.backend.database.init_db - INFO - Database engine disposed.
2025-04-14 14:13:36,599 - ydrpolicy.backend.database - INFO - Database command finished.
2025-04-14 14:14:04,401 - ydrpolicy.backend.database - INFO - Executing database command...
2025-04-14 14:14:04,402 - ydrpolicy.backend.database - INFO - Database initialization and population requested for URL: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy
2025-04-14 14:14:04,402 - ydrpolicy.backend.database.init_db - INFO - Starting database initialization for: postgresql+asyncpg://pouria:@localhost:5432/ydrpolicy (Populate: True)
2025-04-14 14:14:04,403 - ydrpolicy.backend.database.init_db - INFO - Checking if database 'ydrpolicy' exists...
2025-04-14 14:14:04,411 - ydrpolicy.backend.database.init_db - INFO - Database 'ydrpolicy' already exists.
2025-04-14 14:14:04,414 - ydrpolicy.backend.database.init_db - INFO - Ensuring extension 'vector' exists...
2025-04-14 14:14:04,425 - ydrpolicy.backend.database.init_db - INFO - Extension 'vector' checked/created.
2025-04-14 14:14:04,425 - ydrpolicy.backend.database.init_db - INFO - Creating database tables if they don't exist...
2025-04-14 14:14:04,433 - ydrpolicy.backend.database.init_db - INFO - Tables checked/created.
2025-04-14 14:14:04,433 - ydrpolicy.backend.database.init_db - INFO - Applying search vector triggers...
2025-04-14 14:14:04,438 - ydrpolicy.backend.database.init_db - INFO - Search vector triggers applied.
2025-04-14 14:14:04,439 - ydrpolicy.backend.database.init_db - INFO - Seeding users and potentially populating policies...
2025-04-14 14:14:04,439 - ydrpolicy.backend.database.init_db - INFO - Attempting to seed users from: /Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/auth/users.json
2025-04-14 14:14:04,446 - ydrpolicy.backend.database.init_db - INFO - User seeding complete. Prepared: 0, Skipped: 4
2025-04-14 14:14:04,447 - ydrpolicy.backend.database.init_db - INFO - Starting policy data population from scraped_policies directory...
2025-04-14 14:14:04,447 - ydrpolicy.backend.database.init_db - INFO - Scanning scraped policies directory: /Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/tests/data_collection/test_data/processed/scraped_policies
2025-04-14 14:14:04,451 - ydrpolicy.backend.database.init_db - INFO - Reading policy descriptions from CSV: /Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/tests/data_collection/test_data/processed/processed_policies_log.csv
2025-04-14 14:14:04,452 - ydrpolicy.backend.database.init_db - INFO - Loaded 17 timestamp mappings and 17 URL mappings.
2025-04-14 14:14:04,453 - ydrpolicy.backend.database.init_db - INFO - Fetching existing policy information from database...
2025-04-14 14:14:04,455 - ydrpolicy.backend.database.init_db - INFO - Found 0 existing policies in database.
2025-04-14 14:14:04,455 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'Yale_University_Policy_on_Conflict_of_Interest' from folder: Yale_University_Policy_on_Conflict_of_Interest_20250409192912567168
2025-04-14 14:14:04,473 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 1
2025-04-14 14:14:04,473 - ydrpolicy.backend.database.init_db - INFO -   Split text into 9 chunks.
2025-04-14 14:14:04,485 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 9 texts
2025-04-14 14:14:05,811 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 9 embeddings
2025-04-14 14:14:05,812 - ydrpolicy.backend.database.init_db - INFO -   Generated 9 embeddings.
2025-04-14 14:14:05,839 - ydrpolicy.backend.database.init_db - INFO -   Added 9 PolicyChunk records.
2025-04-14 14:14:05,840 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'Residents_Wellbeing_Policy' from folder: Residents_Wellbeing_Policy_20250409193300717366
2025-04-14 14:14:05,847 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 2
2025-04-14 14:14:05,848 - ydrpolicy.backend.database.init_db - INFO -   Split text into 9 chunks.
2025-04-14 14:14:05,848 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 9 texts
2025-04-14 14:14:06,993 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 9 embeddings
2025-04-14 14:14:06,994 - ydrpolicy.backend.database.init_db - INFO -   Generated 9 embeddings.
2025-04-14 14:14:07,015 - ydrpolicy.backend.database.init_db - INFO -   Added 9 PolicyChunk records.
2025-04-14 14:14:07,016 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'School_of_Medicine_Sabbatical_and_Triennial_Leave_Policy' from folder: School_of_Medicine_Sabbatical_and_Triennial_Leave_Policy_20250409193128387433
2025-04-14 14:14:07,022 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 3
2025-04-14 14:14:07,023 - ydrpolicy.backend.database.init_db - INFO -   Split text into 5 chunks.
2025-04-14 14:14:07,023 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 5 texts
2025-04-14 14:14:09,145 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 5 embeddings
2025-04-14 14:14:09,146 - ydrpolicy.backend.database.init_db - INFO -   Generated 5 embeddings.
2025-04-14 14:14:09,157 - ydrpolicy.backend.database.init_db - INFO -   Added 5 PolicyChunk records.
2025-04-14 14:14:09,158 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'Controller_s_Office_Factsheet' from folder: Controller_s_Office_Factsheet_20250409194424987413
2025-04-14 14:14:09,164 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 4
2025-04-14 14:14:09,165 - ydrpolicy.backend.database.init_db - INFO -   Split text into 21 chunks.
2025-04-14 14:14:09,166 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 21 texts
2025-04-14 14:14:10,138 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 21 embeddings
2025-04-14 14:14:10,139 - ydrpolicy.backend.database.init_db - INFO -   Generated 21 embeddings.
2025-04-14 14:14:10,177 - ydrpolicy.backend.database.init_db - INFO -   Added 21 PolicyChunk records.
2025-04-14 14:14:10,178 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'Voluntary_Faculty_Appointment_Application_Requirements_Process' from folder: Voluntary_Faculty_Appointment_Application_Requirements_Process_20250409193339788344
2025-04-14 14:14:10,181 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 5
2025-04-14 14:14:10,182 - ydrpolicy.backend.database.init_db - INFO -   Split text into 3 chunks.
2025-04-14 14:14:10,182 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 3 texts
2025-04-14 14:14:11,598 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 3 embeddings
2025-04-14 14:14:11,599 - ydrpolicy.backend.database.init_db - INFO -   Generated 3 embeddings.
2025-04-14 14:14:11,609 - ydrpolicy.backend.database.init_db - INFO -   Added 3 PolicyChunk records.
2025-04-14 14:14:11,612 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'Workday_Finance_User-Based_Security_Groups_Request_Process' from folder: Workday_Finance_User-Based_Security_Groups_Request_Process_20250409194153006635
2025-04-14 14:14:11,618 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 6
2025-04-14 14:14:11,620 - ydrpolicy.backend.database.init_db - INFO -   Split text into 3 chunks.
2025-04-14 14:14:11,620 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 3 texts
2025-04-14 14:14:12,521 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 3 embeddings
2025-04-14 14:14:12,523 - ydrpolicy.backend.database.init_db - INFO -   Generated 3 embeddings.
2025-04-14 14:14:12,531 - ydrpolicy.backend.database.init_db - INFO -   Added 3 PolicyChunk records.
2025-04-14 14:14:12,533 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'Staff_Workplace_Policies' from folder: Staff_Workplace_Policies_20250409204542316052
2025-04-14 14:14:12,577 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 7
2025-04-14 14:14:12,585 - ydrpolicy.backend.database.init_db - INFO -   Split text into 333 chunks.
2025-04-14 14:14:12,586 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 333 texts
2025-04-14 14:14:14,160 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 333 embeddings
2025-04-14 14:14:14,161 - ydrpolicy.backend.database.init_db - INFO -   Generated 333 embeddings.
2025-04-14 14:14:14,435 - ydrpolicy.backend.database.init_db - INFO -   Added 333 PolicyChunk records.
2025-04-14 14:14:14,439 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'Grand_Rounds_Allowable_Expenses' from folder: Grand_Rounds_Allowable_Expenses_20250409192920823251
2025-04-14 14:14:14,442 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 8
2025-04-14 14:14:14,443 - ydrpolicy.backend.database.init_db - INFO -   Split text into 5 chunks.
2025-04-14 14:14:14,443 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 5 texts
2025-04-14 14:14:15,598 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 5 embeddings
2025-04-14 14:14:15,599 - ydrpolicy.backend.database.init_db - INFO -   Generated 5 embeddings.
2025-04-14 14:14:15,612 - ydrpolicy.backend.database.init_db - INFO -   Added 5 PolicyChunk records.
2025-04-14 14:14:15,614 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'Voluntary_Faculty_Guidelines_Clarification' from folder: Voluntary_Faculty_Guidelines_Clarification_20250409193316792165
2025-04-14 14:14:15,618 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 9
2025-04-14 14:14:15,619 - ydrpolicy.backend.database.init_db - INFO -   Split text into 9 chunks.
2025-04-14 14:14:15,620 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 9 texts
2025-04-14 14:14:16,457 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 9 embeddings
2025-04-14 14:14:16,458 - ydrpolicy.backend.database.init_db - INFO -   Generated 9 embeddings.
2025-04-14 14:14:16,479 - ydrpolicy.backend.database.init_db - INFO -   Added 9 PolicyChunk records.
2025-04-14 14:14:16,480 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'Guidelines_for_Appointment' from folder: Guidelines_for_Appointment_20250409193232742762
2025-04-14 14:14:16,485 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 10
2025-04-14 14:14:16,486 - ydrpolicy.backend.database.init_db - INFO -   Split text into 6 chunks.
2025-04-14 14:14:16,487 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 6 texts
2025-04-14 14:14:17,399 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 6 embeddings
2025-04-14 14:14:17,400 - ydrpolicy.backend.database.init_db - INFO -   Generated 6 embeddings.
2025-04-14 14:14:17,416 - ydrpolicy.backend.database.init_db - INFO -   Added 6 PolicyChunk records.
2025-04-14 14:14:17,417 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'Critical_Out-Patient_Imaging_Findings_-_Immediate_Medical_Care_SOP' from folder: Critical_Out-Patient_Imaging_Findings_-_Immediate_Medical_Care_SOP_20250409193528279122
2025-04-14 14:14:17,422 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 11
2025-04-14 14:14:17,423 - ydrpolicy.backend.database.init_db - INFO -   Split text into 5 chunks.
2025-04-14 14:14:17,424 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 5 texts
2025-04-14 14:14:17,811 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 5 embeddings
2025-04-14 14:14:17,812 - ydrpolicy.backend.database.init_db - INFO -   Generated 5 embeddings.
2025-04-14 14:14:17,826 - ydrpolicy.backend.database.init_db - INFO -   Added 5 PolicyChunk records.
2025-04-14 14:14:17,828 - ydrpolicy.backend.database.init_db - INFO - Processing new policy: 'YDR_Conflict_of_Interest_Policy' from folder: YDR_Conflict_of_Interest_Policy_20250409192856529523
2025-04-14 14:14:17,834 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Created Policy record ID: 12
2025-04-14 14:14:17,835 - ydrpolicy.backend.database.init_db - INFO -   Split text into 7 chunks.
2025-04-14 14:14:17,835 - ydrpolicy.backend.services.embeddings - INFO - Generating embeddings for 7 texts
2025-04-14 14:14:18,665 - ydrpolicy.backend.services.embeddings - INFO - Successfully generated 7 embeddings
2025-04-14 14:14:18,666 - ydrpolicy.backend.database.init_db - INFO -   Generated 7 embeddings.
2025-04-14 14:14:18,684 - ydrpolicy.backend.database.init_db - INFO -   Added 7 PolicyChunk records.
2025-04-14 14:14:18,685 - ydrpolicy.backend.database.init_db - INFO - Policy population finished. Processed/Updated: 12, Deleted old: 0, Skipped: 0
2025-04-14 14:14:18,687 - ydrpolicy.backend.database.init_db - INFO - User seeding and policy population committed.
2025-04-14 14:14:18,688 - ydrpolicy.backend.database.init_db - INFO - SUCCESS: Database initialization completed successfully.
2025-04-14 14:14:18,702 - ydrpolicy.backend.database.init_db - INFO - Database engine disposed.
2025-04-14 14:14:18,703 - ydrpolicy.backend.database - INFO - Database command finished.
2025-04-14 14:16:44,150 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 14:16:44,150 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 14:16:44,150 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 14:16:44,151 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 14:16:44,415 - ydrpolicy.backend.agent - CRITICAL - Failed to start FastAPI server: email-validator is not installed, run `pip install pydantic[email]`
Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/networks.py", line 925, in import_email_validator
    import email_validator
ModuleNotFoundError: No module named 'email_validator'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/main.py", line 418, in agent_command
    uvicorn.run(
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/main.py", line 579, in run
    server.run()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 66, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 70, in serve
    await self._serve(sockets)
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/server.py", line 77, in _serve
    config.load()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/config.py", line 435, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 999, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/api_main.py", line 13, in <module>
    from ydrpolicy.backend.routers import auth as auth_router # Import the auth router
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/routers/auth.py", line 21, in <module>
    from ydrpolicy.backend.schemas.user import UserRead
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/ydrpolicy/backend/schemas/user.py", line 9, in <module>
    class UserBase(BaseModel):
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_model_construction.py", line 224, in __new__
    complete_model_class(
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_model_construction.py", line 602, in complete_model_class
    schema = cls.__get_pydantic_core_schema__(cls, handler)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/main.py", line 702, in __get_pydantic_core_schema__
    return handler(source)
           ^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_schema_generation_shared.py", line 84, in __call__
    schema = self._handler(source_type)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py", line 610, in generate_schema
    schema = self._generate_schema_inner(obj)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py", line 879, in _generate_schema_inner
    return self._model_schema(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py", line 691, in _model_schema
    {k: self._generate_md_field_schema(k, v, decorators) for k, v in fields.items()},
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py", line 1071, in _generate_md_field_schema
    common_field = self._common_field_schema(name, field_info, decorators)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py", line 1263, in _common_field_schema
    schema = self._apply_annotations(
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py", line 2056, in _apply_annotations
    schema = get_inner_schema(source_type)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_schema_generation_shared.py", line 84, in __call__
    schema = self._handler(source_type)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py", line 2035, in inner_handler
    from_property = self._generate_schema_from_property(obj, source_type)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py", line 759, in _generate_schema_from_property
    schema = get_schema(
             ^^^^^^^^^^^
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/networks.py", line 965, in __get_pydantic_core_schema__
    import_email_validator()
  File "/Users/pouria/Documents/Coding/YDRP-RAG/ydrp_engine/.venv/lib/python3.12/site-packages/pydantic/networks.py", line 927, in import_email_validator
    raise ImportError('email-validator is not installed, run `pip install pydantic[email]`') from e
ImportError: email-validator is not installed, run `pip install pydantic[email]`
2025-04-14 14:17:05,398 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 14:17:05,399 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 14:17:05,399 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 14:17:05,399 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 14:17:05,627 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 14:17:05,627 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Initiated...
2025-04-14 14:17:05,628 - ydrpolicy.backend.api_main - INFO - Mode: Production
2025-04-14 14:17:05,628 - ydrpolicy.backend.api_main - INFO - CORS Origins Allowed: ['http://localhost:3000']
2025-04-14 14:17:05,628 - ydrpolicy.backend.api_main - INFO - Verified required directories exist.
2025-04-14 14:17:05,628 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Complete.
2025-04-14 14:17:05,629 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 14:19:39,936 - ydrpolicy.backend.database.engine - INFO - Creating new database engine
2025-04-14 14:19:39,960 - ydrpolicy.backend.database.engine - INFO - Database engine created successfully
2025-04-14 14:19:39,961 - ydrpolicy.backend.routers.auth - INFO - Attempting login for user: testuser1@example.com
2025-04-14 14:19:40,198 - ydrpolicy.backend.routers.auth - INFO - Login successful, token created for user: testuser1@example.com
2025-04-14 14:22:59,419 - ydrpolicy.backend.routers.auth - INFO - Attempting login for user: testuser1@example.com
2025-04-14 14:22:59,621 - ydrpolicy.backend.routers.auth - INFO - Login successful, token created for user: testuser1@example.com
2025-04-14 14:26:28,146 - ydrpolicy.backend.routers.auth - INFO - Attempting login for user: testuser1@example.com
2025-04-14 14:26:28,342 - ydrpolicy.backend.routers.auth - INFO - Login successful, token created for user: testuser1@example.com
2025-04-14 14:27:08,868 - ydrpolicy.backend.routers.auth - INFO - Fetching details for authenticated user: testuser1@example.com
2025-04-14 14:27:48,582 - ydrpolicy.backend.routers.chat - INFO - API: Received request to list chats for user 2 (authenticated) (skip=0, limit=100).
2025-04-14 14:28:23,837 - ydrpolicy.backend.services.chat_service - INFO - ChatService initialized (MCP Enabled: True)
2025-04-14 14:28:23,844 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 2 (authenticated), chat 0: Hi. This is Pouria. Who are you?...
2025-04-14 14:28:23,848 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 2, chat 0, message: 'Hi. This is Pouria. Who are you?...'
2025-04-14 14:28:23,849 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 14:28:23,850 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 14:28:23,850 - ydrpolicy.backend.agent.mcp_connection - WARNING - MCP Host 0.0.0.0 detected, using 'localhost' for client connection.
2025-04-14 14:28:23,851 - ydrpolicy.backend.agent.mcp_connection - INFO - Initializing MCP Server connection to: http://localhost:8001/sse
2025-04-14 14:28:23,852 - ydrpolicy.backend.agent.mcp_connection - INFO - MCPServerSse instance created.
2025-04-14 14:28:23,852 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 14:28:23,853 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 14:28:23,853 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 14:28:23,897 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 14:28:23,898 - ydrpolicy.backend.database.repository.chats - INFO - Creating new chat for user ID 2 with title 'Hi. This is Pouria. Who are you?'.
2025-04-14 14:28:23,906 - ydrpolicy.backend.database.repository.chats - INFO - SUCCESS: Successfully created chat ID 1 for user ID 2.
2025-04-14 14:28:23,907 - ydrpolicy.backend.services.chat_service - INFO - Created new chat ID 1 for user 2.
2025-04-14 14:28:23,923 - ydrpolicy.backend.services.chat_service - INFO - Agent updated to: YDR Policy Assistant in chat 1
2025-04-14 14:28:30,875 - ydrpolicy.backend.services.chat_service - INFO - Agent stream completed successfully for chat 1.
2025-04-14 14:28:30,885 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'complete' for chat 1
2025-04-14 14:28:30,897 - ydrpolicy.backend.routers.chat - INFO - API: Finished streaming response for user 2, chat new.
2025-04-14 14:29:06,738 - ydrpolicy.backend.services.chat_service - INFO - ChatService initialized (MCP Enabled: True)
2025-04-14 14:29:06,741 - ydrpolicy.backend.routers.chat - INFO - API: Received chat stream request for user 2 (authenticated), chat 1: Can you tell me Yale policies on residents shift in high volume hours?...
2025-04-14 14:29:06,743 - ydrpolicy.backend.services.chat_service - INFO - Processing message stream for user 2, chat 1, message: 'Can you tell me Yale policies on residents shift in high volume hours?...'
2025-04-14 14:29:06,744 - ydrpolicy.backend.services.chat_service - INFO - Initializing Policy Agent for ChatService...
2025-04-14 14:29:06,744 - ydrpolicy.backend.agent.policy_agent - INFO - Creating Policy Agent (MCP Enabled: True)...
2025-04-14 14:29:06,745 - ydrpolicy.backend.agent.policy_agent - INFO - MCP server configured for the agent.
2025-04-14 14:29:06,746 - ydrpolicy.backend.agent.policy_agent - INFO - SUCCESS: Policy Agent instance created successfully.
2025-04-14 14:29:06,746 - ydrpolicy.backend.services.chat_service - INFO - Policy Agent initialized successfully in ChatService.
2025-04-14 14:29:06,784 - ydrpolicy.backend.services.chat_service - INFO - API Mode: MCP connection established via async context.
2025-04-14 14:29:06,807 - ydrpolicy.backend.services.chat_service - INFO - Agent updated to: YDR Policy Assistant in chat 1
2025-04-14 14:29:10,045 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='residents shift high volume hours...', k=5, threshold=None
2025-04-14 14:29:10,824 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 14:29:10,865 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 14:29:10,888 - ydrpolicy.backend.services.chat_service - INFO - Agent calling tool: find_similar_chunks in chat 1
2025-04-14 14:29:10,889 - ydrpolicy.backend.services.chat_service - WARNING - ToolCallOutputItem missing tool_call_id for chat 1
2025-04-14 14:29:10,900 - ydrpolicy.backend.services.chat_service - INFO - Tool output received for chat 1
2025-04-14 14:29:17,832 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='Yale Diagnostic Radiology policies residents shift...', k=5, threshold=None
2025-04-14 14:29:18,801 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 14:29:18,816 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 14:29:18,837 - ydrpolicy.backend.services.chat_service - INFO - Agent calling tool: find_similar_chunks in chat 1
2025-04-14 14:29:18,838 - ydrpolicy.backend.services.chat_service - WARNING - ToolCallOutputItem missing tool_call_id for chat 1
2025-04-14 14:29:18,851 - ydrpolicy.backend.services.chat_service - INFO - Tool output received for chat 1
2025-04-14 14:29:30,476 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='residents high volume shifts diagnostic radiology ...', k=5, threshold=None
2025-04-14 14:29:31,395 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 14:29:31,409 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 14:29:31,431 - ydrpolicy.backend.services.chat_service - INFO - Agent calling tool: find_similar_chunks in chat 1
2025-04-14 14:29:31,433 - ydrpolicy.backend.services.chat_service - WARNING - ToolCallOutputItem missing tool_call_id for chat 1
2025-04-14 14:29:31,445 - ydrpolicy.backend.services.chat_service - INFO - Tool output received for chat 1
2025-04-14 14:29:46,941 - ydrpolicy.backend.mcp.server - INFO - Received find_similar_chunks request: query='diagnostic radiology residents scheduling high vol...', k=5, threshold=None
2025-04-14 14:29:47,986 - ydrpolicy.backend.database.repository.policies - INFO - Performing vector-only search with limit=5, threshold=0.2
2025-04-14 14:29:47,995 - ydrpolicy.backend.mcp.server - INFO - Found 5 similar chunks.
2025-04-14 14:29:48,011 - ydrpolicy.backend.services.chat_service - INFO - Agent calling tool: find_similar_chunks in chat 1
2025-04-14 14:29:48,011 - ydrpolicy.backend.services.chat_service - WARNING - ToolCallOutputItem missing tool_call_id for chat 1
2025-04-14 14:29:48,023 - ydrpolicy.backend.services.chat_service - INFO - Tool output received for chat 1
2025-04-14 14:30:01,490 - ydrpolicy.backend.mcp.server - INFO - Received get_policy_from_ID request for policy_id: 2
2025-04-14 14:30:01,537 - ydrpolicy.backend.services.chat_service - INFO - Agent calling tool: get_policy_from_ID in chat 1
2025-04-14 14:30:01,537 - ydrpolicy.backend.services.chat_service - WARNING - ToolCallOutputItem missing tool_call_id for chat 1
2025-04-14 14:30:01,548 - ydrpolicy.backend.services.chat_service - INFO - Tool output received for chat 1
2025-04-14 14:30:14,707 - ydrpolicy.backend.services.chat_service - INFO - Agent stream completed successfully for chat 1.
2025-04-14 14:30:14,714 - ydrpolicy.backend.services.chat_service - INFO - Sending final status 'complete' for chat 1
2025-04-14 14:30:14,727 - ydrpolicy.backend.routers.chat - INFO - API: Finished streaming response for user 2, chat 1.
2025-04-14 14:32:50,851 - ydrpolicy.backend.routers.chat - INFO - API: Received request to list chats for user 2 (authenticated) (skip=0, limit=100).
2025-04-14 14:33:05,199 - ydrpolicy.backend.routers.chat - INFO - API: Received request for messages in chat 1 for user 2 (authenticated) (skip=0, limit=100).
2025-04-14 14:34:02,830 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 14:34:02,833 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Initiated...
2025-04-14 14:34:02,833 - ydrpolicy.backend.agent.mcp_connection - INFO - Closing MCP server connection...
2025-04-14 14:34:02,834 - ydrpolicy.backend.agent.mcp_connection - INFO - MCP server connection closed.
2025-04-14 14:34:02,835 - ydrpolicy.backend.database.engine - INFO - Closing database connection pool
2025-04-14 14:34:02,840 - ydrpolicy.backend.database.engine - INFO - Database connection pool closed
2025-04-14 14:34:02,842 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Complete.
2025-04-14 14:34:02,842 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 14:34:13,276 - ydrpolicy.backend.agent - INFO - Executing agent command...
2025-04-14 14:34:13,276 - ydrpolicy.backend.agent - INFO - Agent requested mode: API
2025-04-14 14:34:13,276 - ydrpolicy.backend.agent - INFO - MCP Tool Connection: Enabled
2025-04-14 14:34:13,276 - ydrpolicy.backend.agent - INFO - Starting agent via FastAPI server on 0.0.0.0:8000 (History Enabled)...
2025-04-14 14:34:13,558 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 14:34:13,559 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Initiated...
2025-04-14 14:34:13,559 - ydrpolicy.backend.api_main - INFO - Mode: Production
2025-04-14 14:34:13,559 - ydrpolicy.backend.api_main - INFO - CORS Origins Allowed: ['http://localhost:3000']
2025-04-14 14:34:13,560 - ydrpolicy.backend.api_main - INFO - Verified required directories exist.
2025-04-14 14:34:13,560 - ydrpolicy.backend.api_main - INFO - FastAPI Application Startup Complete.
2025-04-14 14:34:13,560 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 14:34:49,276 - ydrpolicy.backend.database.engine - INFO - Creating new database engine
2025-04-14 14:34:49,299 - ydrpolicy.backend.database.engine - INFO - Database engine created successfully
2025-04-14 14:34:49,299 - ydrpolicy.backend.routers.auth - INFO - Attempting login for user: testuser1@example.com
2025-04-14 14:34:49,814 - ydrpolicy.backend.routers.auth - INFO - Login successful, token created for user: testuser1@example.com
2025-04-14 14:34:54,852 - ydrpolicy.backend.routers.chat - INFO - API: Received request for messages in chat 1 for user 2 (authenticated) (skip=0, limit=100).
2025-04-14 14:35:05,787 - ydrpolicy.backend.api_main - INFO - ================================================================================
2025-04-14 14:35:05,789 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Initiated...
2025-04-14 14:35:05,790 - ydrpolicy.backend.database.engine - INFO - Closing database connection pool
2025-04-14 14:35:05,795 - ydrpolicy.backend.database.engine - INFO - Database connection pool closed
2025-04-14 14:35:05,797 - ydrpolicy.backend.api_main - INFO - FastAPI Application Shutdown Complete.
2025-04-14 14:35:05,798 - ydrpolicy.backend.api_main - INFO - ================================================================================
